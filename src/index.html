<!doctype html>
<notebook theme="air">
  <title>Notebooks</title>
  <script id="1" type="text/markdown">
    # Notebooks
  </script>
  <script id="2" type="module">
    const dataEl = document.getElementById('notebooksIndexData');
    const notebooks = dataEl ? JSON.parse(dataEl.textContent) : [];

    // Get active tag from URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const activeTag = urlParams.get('tag');
  </script>
  <script id="3" type="module">
    const notebooksWithImages = notebooks.map((nb) => ({
      ...nb,
      imageUrl: nb.imageExt ? `./${nb.path}meta.${nb.imageExt}` : null
    }));

    // Filter notebooks by active tag if one is selected
    const filteredNotebooks = activeTag
      ? notebooksWithImages.filter(nb => nb.tags?.includes(activeTag))
      : notebooksWithImages;
  </script>
  <script id="4" type="module">
    function renderTag(tag) {
      return html`<a href="?tag=${encodeURIComponent(tag)}" class="index__tag" onclick="event.stopPropagation()">${tag}</a>`;
    }

    function renderCard(nb) {
      const imageContent = nb.imageUrl
        ? html`<img class="index__image" src="${nb.imageUrl}" alt="" loading="lazy" />`
        : html`<div class="index__placeholder"></div>`;

      const tagsContent = nb.tags?.length
        ? html`<div class="index__tags">${nb.tags.map(tag => renderTag(tag))}</div>`
        : '';

      return html`<li class="index__item">
        <a href="${nb.path}" class="index__link">
          <div class="index__image-container">
            ${imageContent}
          </div>
          <div class="index__content">
            <h2 class="index__title">${nb.title}</h2>
            <div class="index__meta">
              ${nb.publishedAt ? html`<time class="index__date">${nb.publishedAt}</time>` : ''}
              ${tagsContent}
            </div>
          </div>
        </a>
      </li>`;
    }

    // Render active tag filter if present
    const activeFilterHtml = activeTag
      ? html`<div class="index__active-filter">
          <span class="index__filter-label">Filtered by:</span>
          <span class="index__filter-tag">
            ${activeTag}
            <a href="./" class="index__filter-remove" aria-label="Remove filter">Ã—</a>
          </span>
        </div>`
      : '';

    display(html`
      ${activeFilterHtml}
      <ul class="index">${filteredNotebooks.map(renderCard)}</ul>
    `);
  </script>
</notebook>
