function Q(n,r,l={}){const _=l.fov||Math.PI/4,m=l.near||.1,L=l.far||1e3,u=l.rotateSpeed||1,b=l.zoomSpeed||.001,f=l.panSpeed||1,O=l.deferEvents||!1,D=new Float32Array(16),i=new Float32Array(16),y=new Float32Array(16);let h=!0,C=!1,E=null,g=0,p=0,a=0,d=0,j=0,N=0,M=!1;const k=5;let w=0,x=0,T=0,Y=null;function v(t){const e=1/Math.tan(_/2),c=1/(m-L);i[0]=e/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=(m+L)*c,i[11]=-1,i[12]=0,i[13]=0,i[14]=m*L*c*2,i[15]=0}function K(t){r.view(D),v(t);for(let e=0;e<4;e++)for(let c=0;c<4;c++){let o=0;for(let s=0;s<4;s++)o+=i[e+s*4]*D[s+c*4];y[e+c*4]=o}}function z(t){if(t.target.tagName==="INPUT"||t.target.tagName==="BUTTON"||t.target.tagName==="SELECT")return;j=t.clientX,N=t.clientY,g=t.clientX,p=t.clientY,M=!1;const e=n.getBoundingClientRect();a=(t.clientX-e.left-e.width/2)/e.height,d=(t.clientY-e.top-e.height/2)/e.height,E=t.shiftKey||t.button===2?"pan":"rotate",C=!0,window.addEventListener("mousemove",B),window.addEventListener("mouseup",R)}function B(t){if(!C)return;if(!M){const o=t.clientX-j,s=t.clientY-N;if(Math.sqrt(o*o+s*s)<k)return;M=!0,t.preventDefault()}const e=t.clientX-g,c=t.clientY-p;if(g=t.clientX,p=t.clientY,E==="rotate"){const o=n.getBoundingClientRect(),s=(t.clientX-o.left-o.width/2)/o.height,X=(t.clientY-o.top-o.height/2)/o.height;r.rotate([-a*u,-d*u],[-s*u,-X*u]),a=s,d=X}else if(E==="pan"){const o=n.getBoundingClientRect();r.pan([e/o.height*f,c/o.height*f])}h=!0}function R(){C=!1,E=null,window.removeEventListener("mousemove",B),window.removeEventListener("mouseup",R)}function A(t){t.preventDefault();const e=n.getBoundingClientRect(),c=(t.clientX-e.left-e.width/2)/e.height,o=(t.clientY-e.top-e.height/2)/e.height,s=r.distance;r.zoom(t.deltaY*b*30);const S=1-r.distance/s;r.pan([-c*S*f,-o*S*f]),h=!0}function F(t){if(t.touches.length===1){Y="rotate",g=t.touches[0].clientX,p=t.touches[0].clientY;const e=n.getBoundingClientRect();a=(t.touches[0].clientX-e.left-e.width/2)/e.height,d=(t.touches[0].clientY-e.top-e.height/2)/e.height}else if(t.touches.length===2){t.preventDefault(),Y="pinch";const e=t.touches[1].clientX-t.touches[0].clientX,c=t.touches[1].clientY-t.touches[0].clientY;w=Math.sqrt(e*e+c*c),x=(t.touches[0].clientX+t.touches[1].clientX)/2,T=(t.touches[0].clientY+t.touches[1].clientY)/2}}function Z(t){if(t.touches.length===1&&Y==="rotate"){t.preventDefault();const e=n.getBoundingClientRect(),c=(t.touches[0].clientX-e.left-e.width/2)/e.height,o=(t.touches[0].clientY-e.top-e.height/2)/e.height;r.rotate([-a*u,-d*u],[-c*u,-o*u]),a=c,d=o,g=t.touches[0].clientX,p=t.touches[0].clientY,h=!0}else if(t.touches.length===2&&Y==="pinch"){t.preventDefault();const e=t.touches[1].clientX-t.touches[0].clientX,c=t.touches[1].clientY-t.touches[0].clientY,o=Math.sqrt(e*e+c*c),s=(t.touches[0].clientX+t.touches[1].clientX)/2,X=(t.touches[0].clientY+t.touches[1].clientY)/2;if(w>0){const G=(w/o-1)*30;r.zoom(G);const V=n.getBoundingClientRect(),H=(s-x)/V.height*f,J=(X-T)/V.height*f;r.pan([H,J]),h=!0}w=o,x=s,T=X}}function q(t){if(t.touches.length===0)Y=null,w=0;else if(t.touches.length===1){Y="rotate",g=t.touches[0].clientX,p=t.touches[0].clientY;const e=n.getBoundingClientRect();a=(t.touches[0].clientX-e.left-e.width/2)/e.height,d=(t.touches[0].clientY-e.top-e.height/2)/e.height,w=0}}function I(t){t.preventDefault()}let P=!1;function U(){P||(P=!0,n.addEventListener("mousedown",z),n.addEventListener("wheel",A,{passive:!1}),n.addEventListener("touchstart",F,{passive:!1}),n.addEventListener("touchmove",Z,{passive:!1}),n.addEventListener("touchend",q),n.addEventListener("contextmenu",I))}O||U();function W(){n.removeEventListener("mousedown",z),n.removeEventListener("wheel",A),n.removeEventListener("touchstart",F),n.removeEventListener("touchmove",Z),n.removeEventListener("touchend",q),n.removeEventListener("contextmenu",I),window.removeEventListener("mousemove",B),window.removeEventListener("mouseup",R)}return{attachEvents:U,camera:r,projectionView:y,get dirty(){return h},taint(){h=!0},update(t){K(t);const e=h;return h=!1,{view:D,projection:i,projectionView:y,dirty:e}},destroy:W}}export{Q as createOrbitCameraController,Q as default};
