import{d as r,_ as j}from"./index-ByB2dbry.js";r({root:document.getElementById("cell-1"),expanded:[],variables:[]},{id:1,body:(n,e)=>n`
Imagine trying to combinatorially rearrange the pixels of one image to represent another image the best you can with respect to some metric like the difference in color. (Note that although this may be a fun task, it's most certainly not a particularly good way to accomplish style transfer!)

For a grayscale image, the task is relatively simple. Sort the pixels of source and target image by intensity, putting them into 1:1 correspondence, then reassign by transferring values from the target to the source image. The resulting image would look like the source image but would share the histogram of the target image.

For a color image, the task is not so simple, as RGB tuples permit no useful ordering. The [Hungarian Algorithm](https://en.wikipedia.org/wiki/Hungarian_algorithm) provides an exhaustively brute-force solution to the assignment problem we seek to solve, but its ${e`\mathcal{O}(n^3)`} complexity makes it completely impractical for images. Theo Honohan has pointed to some [good alternative methods](https://graphics.social/@theohonohan/111490607440087628).

Nonetheless, we'll try out an approximate algorithm, though it's best to think of this problem as a nice testbed for the more general algorithm rather than the algorithm as a particularly good solution to our problem. In his article, [Interpolating Color Image Histograms Using Sliced Optimal Transport](https://blog.demofox.org/2023/11/25/interpolating-color-image-histograms-using-sliced-optimal-transport/), Alan Wolfe summarizes the Sliced Optimal Transport method. For the RGB image case, we select a random three-dimensional unit vector and project RGB tuples onto it. We perform the simple grayscale reassignment algorithm, then unproject the resulting per-pixel adjustments back into three dimensions. We perform this task in batches, each time projecting onto a collection of random vectors and averaging the resulting adjustments together before updating the image. The result is an image which looks like the source image but—_approximately_, at least—contains the reordered pixels of the target image.

Alan has described it better than I have so you should read his article; I just wanted to prototype it and get a good intuitive sense of what's going on, and that's all you'll find here. I'm happy with my implementation in general, though I'd like to:
- parallelize work within each batch using web workers
- more intelligently select random vectors`,inputs:["md","tex"],outputs:[],output:void 0,assets:void 0,autodisplay:!0,autoview:!1,automutable:void 0});r({root:document.getElementById("cell-709"),expanded:[],variables:[]},{id:709,body:function(e,t){return e.select(Object.keys(t),{label:"Source",value:"ellingwood"})},inputs:["Inputs","FILES"],outputs:void 0,output:"viewof$sourceFile",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-686"),expanded:[],variables:[]},{id:686,body:function(e,t){return e.select(Object.keys(t),{label:"Target",value:"webb"})},inputs:["Inputs","FILES"],outputs:void 0,output:"viewof$targetFile",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-751"),expanded:[],variables:[]},{id:751,body:function(e){return e.range([1,4],{value:2,label:"Downsample",step:.25})},inputs:["Inputs"],outputs:void 0,output:"viewof$downsample",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-864"),expanded:[],variables:[]},{id:864,body:function(e){return e.range([1,32],{label:"Batch size",value:4,step:1})},inputs:["Inputs"],outputs:void 0,output:"viewof$batchSize",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-862"),expanded:[],variables:[]},{id:862,body:function(e){return e.range([1,1024],{label:"Max iterations",value:100,transform:Math.log,step:1})},inputs:["Inputs"],outputs:void 0,output:"viewof$maxIterations",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-1102"),expanded:[],variables:[]},{id:1102,body:function(e){return e.range([.05,1],{label:"Tolerance",transform:Math.log,value:.3})},inputs:["Inputs"],outputs:void 0,output:"viewof$tolerance",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-969"),expanded:[],variables:[]},{id:969,body:function(e){return e.range([0,1],{label:"Interpolate",value:1})},inputs:["Inputs"],outputs:void 0,output:"viewof$interpolate",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-652"),expanded:[],variables:[]},{id:652,body:function(e){return e.button("Restart")},inputs:["Inputs"],outputs:void 0,output:"viewof$restart",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-477"),expanded:[],variables:[]},{id:477,body:function(n,e,t,a,i,o){return n`
  ${e(t,...a)}
  ${e(i,...a)}
  ${e(o,...a)}
`},inputs:["html","drawImage","srcData","shape","interpolated","targetData"],outputs:void 0,output:void 0,assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-428"),expanded:[],variables:[]},{id:428,body:function(n,e,t,a,i){return n`
  ${e(t)}
  ${e(a)}
  ${e(i)}
`},inputs:["html","plotHistogram","srcData","interpolated","targetData"],outputs:void 0,output:void 0,assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-898"),expanded:[],variables:[]},{id:898,body:function(n,e,t,a){return n.plot({height:150,width:Math.min(e,400),y:{grid:!0,type:"log"},x:{grid:!0},marks:[n.lineY(t,{x:"iteration",y:"delta"}),n.ruleY([a],{strokeDasharray:"4,4",stroke:"rgb(200 0 0)"})]})},inputs:["Plot","width","history","tolerance"],outputs:void 0,output:void 0,assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-1177"),expanded:[],variables:[]},{id:1177,body:function(e){return e.checkbox(["Smooth histogram"],{value:["Smooth histogram"]})},inputs:["Inputs"],outputs:void 0,output:"viewof$smoothHistogram",assets:void 0,autodisplay:!0,autoview:!0,automutable:!1});r({root:document.getElementById("cell-965"),expanded:[],variables:[]},{id:965,body:function(e,t,a){const i=e.src.length,o=new Uint8ClampedArray(i);for(let u=0;u<i;u++)o[u]=t[u]+(e.src[u]-t[u])*a;return o},inputs:["result","srcData","interpolate"],outputs:void 0,output:"interpolated",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-188"),expanded:[],variables:[]},{id:188,body:function(e,t,a,i,o,u,p,s){return t.value=[],a(i.slice(),o,{maxIterations:u,batchSize:p,tolerance:s})},inputs:["restart","mutable$history","slicedOptimalTransport","srcData","targetData","maxIterations","batchSize","tolerance"],outputs:void 0,output:"result",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-1122"),expanded:[],variables:[]},{id:1122,body:function(){return function e(t,a,i,o){let u;if(i>=o)return;const p=t[i+o>>1];let s=i-1,d=o+1;for(;;){do s++;while(t[s]<p);do d--;while(t[d]>p);if(s>=d)break;u=t[s],t[s]=t[d],t[d]=u,u=a[s],a[s]=a[d],a[d]=u}e(t,a,i,d),e(t,a,d+1,o)}},inputs:[],outputs:void 0,output:"sort",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-1060"),expanded:[],variables:[]},{id:1060,body:function(e,t,a,i){return function*(u,p,{maxIterations:s=100,batchSize:d=4,tolerance:I=1}={}){if(u.length!==p.length)throw new Error("Source size must equal target size");e.value=[];const h=u.length>>2,k=new Uint32Array(h),w=new Float32Array(h),E=new Float32Array(h),l=new Float32Array(h*3);let b=1/0,v=0;for(;b>I&&++v<=s;){l.fill(0);for(let g=0;g<d;g++){let[f,c,x]=t([],[a(),a(),a()]);for(let m=0,y=0;m<h;m++,y+=4)k[m]=m,w[m]=f*u[y]+c*u[y+1]+x*u[y+2],E[m]=f*p[y]+c*p[y+1]+x*p[y+2];i(w,k,0,h-1),E.sort();for(let m=0;m<h;m++){const y=E[m]-w[m],B=k[m]*3;l[B+0]+=f*y,l[B+1]+=c*y,l[B+2]+=x*y}}b=0;for(let g=0,f=0;f<h*4;g+=3,f+=4){const c=l[g]/d,x=l[g+1]/d,m=l[g+2]/d;u[f]+=c,u[f+1]+=x,u[f+2]+=m,b+=c*c+x*x+m*m}b=Math.sqrt(b/h),e.value=e.value.concat([{iteration:v,delta:b}]),yield{delta:b,src:u}}return{delta:b,src:u}}},inputs:["mutable$history","vec3normalize","randn","sort"],outputs:void 0,output:"slicedOptimalTransport",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-766"),expanded:[],variables:[]},{id:766,body:function(e,t){return[e.width/t|0,e.height/t|0]},inputs:["src","downsample"],outputs:void 0,output:"shape",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-891"),expanded:[],variables:[]},{id:891,body:function(){return[]},inputs:[],outputs:void 0,output:"mutable history",assets:void 0,autodisplay:!0,autoview:!1,automutable:!0});r({root:document.getElementById("cell-462"),expanded:[],variables:[]},{id:462,body:function(e,t){return function(i,o,u,p=2){const s=e.element("canvas");s.style.width=`${o*t/p}px`,s.style.height=`${u*t/p}px`,s.width=o,s.height=u,s.style.display="inline-block";const d=s.getContext("2d"),I=d.getImageData(0,0,o,u);return I.data.set(i),d.putImageData(I,0,0),s}},inputs:["DOM","downsample"],outputs:void 0,output:"drawImage",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-17"),expanded:[],variables:[]},{id:17,body:function(e){return function(a,i,o){const u=e.element("canvas");u.width=i,u.height=o;const p=u.getContext("2d");return p.drawImage(a,0,0,i,o),p.getImageData(0,0,u.width,u.height).data}},inputs:["DOM"],outputs:void 0,output:"getPixels",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-693"),expanded:[],variables:[]},{id:693,body:function(e){return{ellingwood:e(new URL("ellingwood@1.jpg",import.meta.url).href),gravity:e(new URL("grav-sm.jpg",import.meta.url).href),m61:e(new URL("m61.jpg",import.meta.url).href),webb:e(new URL("webb.jpg",import.meta.url).href),yosemite:e(new URL("yosemite.jpg",import.meta.url).href),yosemite2:e(new URL("yosemite-2.jpg",import.meta.url).href),yosemite3:e(new URL("yosemite-3@1.jpg",import.meta.url).href),yosemite4:e(new URL("yosemite-smog.jpg",import.meta.url).href),topographic:e(new URL("topo.jpg",import.meta.url).href),climber:e(new URL("Fotothek_df_ps_0002300_Sport_^_Klettersport.jpg",import.meta.url).href),bigcat:e(new URL("bigcat.jpg",import.meta.url).href),hokitika:e(new URL("nz-sunset.jpg",import.meta.url).href),"arthur's pass":e(new URL("arthurs-pass.jpg",import.meta.url).href),rainier:e(new URL("rainier.jpg",import.meta.url).href),shelf:e(new URL("shelf.jpg",import.meta.url).href),cranes:e(new URL("cranes.jpg",import.meta.url).href),"smith rock":e(new URL("smith-rock.jpg",import.meta.url).href),dog:e(new URL("dog.jpg",import.meta.url).href),"ansel adams":e(new URL("ansel-adams@1.jpg",import.meta.url).href)}},inputs:["FileAttachment"],outputs:void 0,output:"FILES",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-5"),expanded:[],variables:[]},{id:5,body:async function(e,t,a){return e(await t[a].blob())},inputs:["createImageBitmap","FILES","sourceFile"],outputs:void 0,output:"src",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-7"),expanded:[],variables:[]},{id:7,body:async function(e,t,a){return e(await t[a].blob())},inputs:["createImageBitmap","FILES","targetFile"],outputs:void 0,output:"target",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-25"),expanded:[],variables:[]},{id:25,body:function(e,t,a){return e(t,t.width/a,t.height/a)},inputs:["getPixels","src","downsample"],outputs:void 0,output:"srcData",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-162"),expanded:[],variables:[]},{id:162,body:function(e,t,a,i){return e(t,a.width/i,a.height/i)},inputs:["getPixels","target","src","downsample"],outputs:void 0,output:"targetData",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-1171"),expanded:[],variables:[]},{id:1171,body:function(){return function(t){const a=t.slice(),i=t.length;for(let o=0;o<i;o++)a[o]=.25*(t[Math.max(0,o-1)]+t[Math.min(i-1,o+1)])+.5*t[o];for(let o=0;o<i;o++)t[o]=.25*(a[Math.max(0,o-1)]+a[Math.min(i-1,o+1)])+.5*a[o];return t}},inputs:[],outputs:void 0,output:"smooth",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-104"),expanded:[],variables:[]},{id:104,body:function(e,t,a,i,o){return function(p,{w:s=Math.max(320,Math.min(e.width/devicePixelRatio,t/3))}={}){function d(l){const b=l.length;let v=new Uint16Array(256),g=new Uint16Array(256),f=new Uint16Array(256);for(let c=0;c<b;c+=4)v[l[c]]++,g[l[c+1]]++,f[l[c+2]]++;return~a.indexOf("Smooth histogram")&&(v=i(v),g=i(g),f=i(f)),{r:v,g,b:f}}const{r:I,g:h,b:k}=d(p),w=[];for(let l=0;l<256;l++)w[l]={level:l,r:I[l],g:h[l],b:k[l]};const E=o.plot({height:200,width:s,y:{grid:!0},x:{grid:!0},marks:[o.areaY(w,{x:"level",y:"r",stroke:"rgb(255 0 0/100%)",fill:"rgb(200 0 0/20%)"}),o.areaY(w,{x:"level",y:"g",stroke:"rgb(0 150 0/100%)",fill:"rgb(0 150 0/20%)"}),o.areaY(w,{x:"level",y:"b",stroke:"rgb(0 0 255/100%)",fill:"rgb(0 0 255/15%)"})]});return E.style.display="inline-block",E}},inputs:["src","width","smoothHistogram","smooth","Plot"],outputs:void 0,output:"plotHistogram",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});r({root:document.getElementById("cell-1140"),expanded:[],variables:[]},{id:1140,body:async(n,e)=>{const{vec3normalize:t}=await j(()=>import("https://api.observablehq.com/@rreusser/gl-vec3.js?v=4"),[]).then(a=>{const i={},o=n.module(a.default),u=n.module();if(!o.defines("vec3normalize"))throw new SyntaxError("export 'vec3normalize' not found");return u.variable(i.vec3normalize=e()).import("vec3normalize",o),i});return{vec3normalize:t}},inputs:["__ojs_runtime","__ojs_observer"],outputs:["vec3normalize"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});r({root:document.getElementById("cell-78"),expanded:[],variables:[]},{id:78,body:async function(){return(await j(()=>import("https://cdn.skypack.dev/@stdlib/random-base-randn"),[])).default},inputs:[],outputs:void 0,output:"randn",assets:void 0,autodisplay:!0,autoview:!1,automutable:!1});
