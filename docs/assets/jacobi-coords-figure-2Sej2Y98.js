import{createArrowhead as D,createArrowheadReversed as K,floatRgbToHex as P}from"./initial-conditions-figure-CPctfvuv.js";function N(r,p){const[d,l,y]=p,[[h,g],[i,n],[x,c]]=r,s=h-i,m=g-n,f=(d*h+l*i)/(d+l),u=(d*g+l*n)/(d+l),v=f-x,j=u-c,b=d+l+y,w=(d*h+l*i+y*x)/b,M=(d*g+l*n+y*c)/b;return[[s,m],[v,j],[w,M]]}function Q(r,p){const[d,l,y]=p,[[h,g],[i,n],[x,c]]=r,s=(h-i)/Math.sqrt(2),m=(g-n)/Math.sqrt(2),f=((d*h+l*i)/(d+l)-x)*2/Math.sqrt(6),u=((d*g+l*n)/(d+l)-c)*2/Math.sqrt(6),v=s*s+m*m,j=f*f+u*u,b=v+j;return[2*(s*f+m*u)/b,(j-v)/b,2*(s*u-m*f)/b]}function U(r,p){return[[[r[1][0],r[1][1]],[r[1][0]+p[0][0],r[1][1]+p[0][1]]],[[r[2][0],r[2][1]],[r[2][0]+p[1][0],r[2][1]+p[1][1]]],[[0,0],[p[2][0],p[2][1]]]]}function W(r,p,d,l={}){const y=l.width||480,h=l.height||Math.floor(y*.7),g=p.m,i=r.create("svg").attr("width",y).attr("height",h).style("max-width","100%").style("height","auto"),n=l.initialPositions||[[4,1],[3,2.7],[1,2.5]],x=5,c=r.scaleLinear().domain([-x*.1,x*1.1]).range([0,y]),s=r.scaleLinear().domain([-x*.1*h/y,x*1.1*h/y]).range([h,0]),m=r.line().x(t=>c(t[0])).y(t=>s(t[1])),f=`arrowhead-jacobi-${Math.random().toString(36).slice(2)}`,u=`arrowhead-jacobi-start-${Math.random().toString(36).slice(2)}`,v=i.append("defs");v.append("marker").attr("id",f).call(D()),v.append("marker").attr("id",u).call(K()),i.append("g").attr("class","axes").selectAll("path").data([[[-x*.05,0],[x,0]],[[0,-x*.05*h/y],[0,x*h/y]]]).join("path").attr("d",m).attr("stroke","black").attr("fill","none").attr("stroke-width",1).attr("marker-start",`url(#${u})`).attr("marker-end",`url(#${f})`);const j=d.color,b=d.strokeColor||[[1,1,1],[1,1,1],[1,1,1]],w=p.pointSize.map(t=>Math.max(2.5,t*8)),M=i.append("g").attr("class","bodies"),R=i.append("g").attr("class","jacobi"),G=i.append("g").attr("class","jacobi-labels"),H=i.append("g").attr("class","labels"),O=i.append("g").attr("class","body-labels"),S=i.append("g").attr("class","handles");function T(t,o,A){const a=c(t[0][0]),e=s(t[0][1]),k=c(t[1][0]),$=s(t[1][1]),C=k-a,J=$-e,z=Math.hypot(C,J);if(z<1)return t;const F=C/z,I=J/z;return[[c.invert(a+F*o),s.invert(e+I*o)],[c.invert(k-F*A),s.invert($-I*A)]]}function B(t,o){return[o*t[1][0]+(1-o)*t[0][0],o*t[1][1]+(1-o)*t[0][1]]}const q=[[w[1]+1,w[0]-1+6],[w[2]+1,6],[0,6]],E={node:i.node(),positions:n,getShape:()=>Q(n,g),listeners:[],addEventListener(t,o){this.listeners.push({event:t,fn:o})},dispatchEvent(t){this.listeners.filter(o=>o.event===t.type).forEach(o=>o.fn(t))}};function L(){const t=N(n,g),o=U(n,t);M.selectAll("circle").data(n).join("circle").attr("cx",a=>c(a[0])).attr("cy",a=>s(a[1])).attr("r",(a,e)=>w[e]).attr("fill",(a,e)=>P(j[e])).attr("stroke",(a,e)=>P(b[e])).attr("stroke-width",2),R.selectAll("path").data(o.map((a,e)=>T(a,q[e][0],q[e][1]))).join("path").attr("d",a=>m(a)).attr("stroke","black").attr("fill","none").attr("stroke-width",1.5).attr("marker-end",`url(#${f})`);const A=o.map(a=>B(a,.35));G.selectAll("g.jacobi-label").data(A).join("g").attr("class","jacobi-label").each(function(a,e){const k=r.select(this);k.selectAll("*").remove(),k.append("text").attr("x",c(a[0])).attr("y",s(a[1])).attr("font-size","16px").attr("font-weight",700).attr("font-family","serif").attr("font-style","italic").attr("dy",9).attr("dx",9).text("r").append("tspan").attr("dy",5).attr("font-weight",400).attr("font-size","0.75em").text(e+1)}),O.selectAll("g.body-label").data(n).join("g").attr("class","body-label").each(function(a,e){const k=r.select(this);k.selectAll("*").remove(),k.append("text").attr("x",c(a[0])).attr("y",s(a[1])).attr("font-size","14px").attr("font-family","serif").attr("font-style","italic").attr("dx",3+w[e]*.707).attr("dy",-11+w[e]*.707).attr("text-anchor","top").text("m").append("tspan").attr("dy",5).attr("font-weight",400).attr("font-size","0.75em").text(e+1)}),S.selectAll("circle").attr("cx",(a,e)=>c(n[e][0])).attr("cy",(a,e)=>s(n[e][1])),E.dispatchEvent(new CustomEvent("input"))}return S.selectAll("circle").data(n).join("circle").attr("class","draggable").attr("cx",t=>c(t[0])).attr("cy",t=>s(t[1])).attr("r",25).attr("fill","transparent").attr("cursor","grab").call(r.drag().on("start",function(){r.select(this).attr("cursor","grabbing")}).on("drag",function(t,o){const A=n.indexOf(o);n[A][0]=c.invert(t.x),n[A][1]=s.invert(t.y),L()}).on("end",function(){r.select(this).attr("cursor","grab")})),H.selectAll("text").data([{xy:[0,x*h/y],text:"y"},{xy:[x,0],text:"x"}]).join("text").text(t=>t.text).attr("x",t=>c(t.xy[0])).attr("y",t=>s(t.xy[1])).attr("font-size","14px").attr("font-family","serif").attr("font-style","italic").attr("dy",-2).attr("dx",5),L(),E}export{N as computeJacobi,Q as computeShapeFromPositions,W as createJacobiCoordsFigure};
