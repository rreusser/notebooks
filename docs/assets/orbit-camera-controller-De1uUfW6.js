function Q(o,r,l={}){const V=l.fov||Math.PI/4,L=l.near||.1,y=l.far||1e3,u=l.rotateSpeed||1,_=l.zoomSpeed||.001,f=l.panSpeed||1,O=l.deferEvents||!1,m=new Float32Array(16),i=new Float32Array(16),D=new Float32Array(16);let h=!0,C=!1,E=null,g=0,p=0,a=0,d=0,j=0,N=0,M=!1;const k=5;let w=0,x=0,T=0,Y=null;function v(t){const e=1/Math.tan(V/2),c=1/(L-y);i[0]=e/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=(L+y)*c,i[11]=-1,i[12]=0,i[13]=0,i[14]=L*y*c*2,i[15]=0}function K(t){r.view(m),v(t);for(let e=0;e<4;e++)for(let c=0;c<4;c++){let n=0;for(let s=0;s<4;s++)n+=i[e+s*4]*m[s+c*4];D[e+c*4]=n}}function b(t){if(t.target.tagName==="INPUT"||t.target.tagName==="BUTTON"||t.target.tagName==="SELECT")return;j=t.clientX,N=t.clientY,g=t.clientX,p=t.clientY,M=!1;const e=o.getBoundingClientRect();a=(t.clientX-e.left-e.width/2)/e.height,d=(t.clientY-e.top-e.height/2)/e.height,E=t.shiftKey||t.button===2?"pan":"rotate",C=!0,o.style.cursor="grabbing",window.addEventListener("mousemove",B),window.addEventListener("mouseup",R)}function B(t){if(!C)return;if(!M){const n=t.clientX-j,s=t.clientY-N;if(Math.sqrt(n*n+s*s)<k)return;M=!0,t.preventDefault()}const e=t.clientX-g,c=t.clientY-p;if(g=t.clientX,p=t.clientY,E==="rotate"){const n=o.getBoundingClientRect(),s=(t.clientX-n.left-n.width/2)/n.height,X=(t.clientY-n.top-n.height/2)/n.height;r.rotate([-a*u,-d*u],[-s*u,-X*u]),a=s,d=X}else if(E==="pan"){const n=o.getBoundingClientRect();r.pan([e/n.height*f,c/n.height*f])}h=!0}function R(){C=!1,E=null,o.style.cursor="grab",window.removeEventListener("mousemove",B),window.removeEventListener("mouseup",R)}function z(t){t.preventDefault();const e=o.getBoundingClientRect(),c=(t.clientX-e.left-e.width/2)/e.height,n=(t.clientY-e.top-e.height/2)/e.height,s=r.distance;r.zoom(t.deltaY*_*30);const S=1-r.distance/s;r.pan([-c*S*f,-n*S*f]),h=!0}function A(t){if(t.touches.length===1){Y="rotate",g=t.touches[0].clientX,p=t.touches[0].clientY;const e=o.getBoundingClientRect();a=(t.touches[0].clientX-e.left-e.width/2)/e.height,d=(t.touches[0].clientY-e.top-e.height/2)/e.height}else if(t.touches.length===2){t.preventDefault(),Y="pinch";const e=t.touches[1].clientX-t.touches[0].clientX,c=t.touches[1].clientY-t.touches[0].clientY;w=Math.sqrt(e*e+c*c),x=(t.touches[0].clientX+t.touches[1].clientX)/2,T=(t.touches[0].clientY+t.touches[1].clientY)/2}}function F(t){if(t.touches.length===1&&Y==="rotate"){t.preventDefault();const e=o.getBoundingClientRect(),c=(t.touches[0].clientX-e.left-e.width/2)/e.height,n=(t.touches[0].clientY-e.top-e.height/2)/e.height;r.rotate([-a*u,-d*u],[-c*u,-n*u]),a=c,d=n,g=t.touches[0].clientX,p=t.touches[0].clientY,h=!0}else if(t.touches.length===2&&Y==="pinch"){t.preventDefault();const e=t.touches[1].clientX-t.touches[0].clientX,c=t.touches[1].clientY-t.touches[0].clientY,n=Math.sqrt(e*e+c*c),s=(t.touches[0].clientX+t.touches[1].clientX)/2,X=(t.touches[0].clientY+t.touches[1].clientY)/2;if(w>0){const G=(w/n-1)*30;r.zoom(G);const U=o.getBoundingClientRect(),H=(s-x)/U.height*f,J=(X-T)/U.height*f;r.pan([H,J]),h=!0}w=n,x=s,T=X}}function Z(t){if(t.touches.length===0)Y=null,w=0;else if(t.touches.length===1){Y="rotate",g=t.touches[0].clientX,p=t.touches[0].clientY;const e=o.getBoundingClientRect();a=(t.touches[0].clientX-e.left-e.width/2)/e.height,d=(t.touches[0].clientY-e.top-e.height/2)/e.height,w=0}}function q(t){t.preventDefault()}let I=!1;function P(){I||(I=!0,o.style.cursor="grab",o.addEventListener("mousedown",b),o.addEventListener("wheel",z,{passive:!1}),o.addEventListener("touchstart",A,{passive:!1}),o.addEventListener("touchmove",F,{passive:!1}),o.addEventListener("touchend",Z),o.addEventListener("contextmenu",q))}O||P();function W(){o.removeEventListener("mousedown",b),o.removeEventListener("wheel",z),o.removeEventListener("touchstart",A),o.removeEventListener("touchmove",F),o.removeEventListener("touchend",Z),o.removeEventListener("contextmenu",q),window.removeEventListener("mousemove",B),window.removeEventListener("mouseup",R)}return{attachEvents:P,camera:r,projectionView:D,get dirty(){return h},taint(){h=!0},update(t){K(t);const e=h;return h=!1,{view:m,projection:i,projectionView:D,dirty:e}},destroy:W}}export{Q as createOrbitCameraController,Q as default};
