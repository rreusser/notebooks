function q(v){return v*360-180}function U(v){return Math.atan(Math.sinh(Math.PI*(1-2*v)))*180/Math.PI}const Z=6371e3,w=3.28084,R=621371e-9;function tt(v,s,n,l){const o=Math.PI/180,i=(l-s)*o,t=(n-v)*o,a=Math.sin(i/2)**2+Math.cos(s*o)*Math.cos(l*o)*Math.sin(t/2)**2;return 2*Z*Math.asin(Math.sqrt(a))}function j(v,s){const n=v/s,l=Math.pow(10,Math.floor(Math.log10(n))),o=n/l;let i;return o<=1.5?i=1:o<=3?i=2:o<=7?i=5:i=10,i*l}class nt{constructor(){this._panel=null,this._canvas=null,this._ctx=null,this._title=null,this._resizeObserver=null,this._layerId=null,this._lineColor=null,this._distances=null,this._elevations=null,this._boundDraw=this._draw.bind(this),this._drawScheduled=!1}createDOM(){const s=document.createElement("div");s.className="elevation-profile-panel";const n=document.createElement("div");n.className="elevation-profile-header";const l=document.createElement("span");l.className="elevation-profile-title",n.appendChild(l);const o=document.createElement("button");o.className="elevation-profile-close",o.title="Close",o.innerHTML='<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 4l8 8M12 4l-8 8"/></svg>',o.addEventListener("click",()=>this.hide()),n.appendChild(o),s.appendChild(n);const i=document.createElement("canvas");return i.className="elevation-profile-canvas",s.appendChild(i),this._panel=s,this._canvas=i,this._ctx=i.getContext("2d"),this._title=l,this._resizeObserver=new ResizeObserver(()=>this._scheduleDraw()),this._resizeObserver.observe(s),i.addEventListener("mousemove",t=>this._onMouseMove(t)),i.addEventListener("mouseleave",()=>this._onMouseLeave()),this._hoverIndex=-1,s}show(s,n,l,o){this._layerId=s,this._lineColor=o,this._title.textContent=n,this._computeDistances(l),this._panel.classList.add("visible"),this._scheduleDraw()}update(s){this._layerId&&(this._computeDistances(s),this._scheduleDraw())}hide(){this._panel.classList.remove("visible"),this._layerId=null,this._distances=null,this._elevations=null,this._hoverIndex=-1}get activeLayerId(){return this._layerId}destroy(){this._resizeObserver&&this._resizeObserver.disconnect(),this._panel&&this._panel.parentElement&&this._panel.parentElement.removeChild(this._panel)}_computeDistances(s){if(!s){this._distances=null,this._elevations=null;return}const n=[],l=[];let o=0;for(const i of s)for(let t=0;t<i.coords.length;t++){if(t>0){const a=i.coords[t-1],f=i.coords[t],r=q(a.mercatorX),m=U(a.mercatorY),d=q(f.mercatorX),L=U(f.mercatorY);o+=tt(r,m,d,L)}n.push(o),l.push(i.elevations[t])}this._distances=n,this._elevations=l}_scheduleDraw(){this._drawScheduled||(this._drawScheduled=!0,requestAnimationFrame(this._boundDraw))}_draw(){if(this._drawScheduled=!1,!this._panel.classList.contains("visible")||!this._distances)return;const s=this._canvas,n=s.getBoundingClientRect();if(n.width===0||n.height===0)return;const l=window.devicePixelRatio||1,o=Math.floor(n.width*l),i=Math.floor(n.height*l);(s.width!==o||s.height!==i)&&(s.width=o,s.height=i);const t=this._ctx;t.setTransform(l,0,0,l,0,0),t.clearRect(0,0,n.width,n.height);const a=this._distances,f=this._elevations;if(a.length<2)return;const r=56,m=16,d=10,L=24,M=n.width-r-m,g=n.height-d-L;if(M<=0||g<=0)return;let b=1/0,P=-1/0;for(const e of f)e>0&&(e<b&&(b=e),e>P&&(P=e));if(!isFinite(b))return;const O=b*w,$=P*w,B=($-O||100)*.05,p=O-B,k=$+B,z=a[a.length-1];if(z<=0)return;const I=z*R;function y(e){return r+e*R/I*M}function x(e){return d+g-(e-p)/(k-p)*g}const C=this._lineColor||[1,.53,0,1],A=Math.round(C[0]*255),W=Math.round(C[1]*255),N=Math.round(C[2]*255),X=`rgb(${A},${W},${N})`,G=`rgba(${A},${W},${N},0.3)`;t.font="10px system-ui, sans-serif",t.textBaseline="middle";const E=j(k-p,4),J=Math.ceil(p/E)*E;t.strokeStyle="rgba(0,0,0,0.08)",t.lineWidth=1,t.fillStyle="#666",t.textAlign="right";for(let e=J;e<=k;e+=E){const c=x(e);t.beginPath(),t.moveTo(r,c),t.lineTo(r+M,c),t.stroke();const h=e>=1e3?`${(e/1e3).toFixed(1)}k`:Math.round(e).toString();t.fillText(h+" ft",r-4,c)}const T=j(I,5);t.textAlign="center",t.textBaseline="top";const K=Math.ceil(0/T)*T||T;for(let e=K;e<=I;e+=T){const c=r+e/I*M;t.beginPath(),t.moveTo(c,d),t.lineTo(c,d+g),t.stroke(),t.fillStyle="#666",t.fillText(e.toFixed(1)+" mi",c,d+g+4)}t.save(),t.beginPath(),t.rect(r,d,M,g),t.clip();let u=!1;t.fillStyle=G;for(let e=0;e<a.length;e++){const c=f[e];if(c>0){const h=y(a[e]),_=x(c*w);u?t.lineTo(h,_):(t.beginPath(),t.moveTo(h,x(p)),t.lineTo(h,_),u=!0)}else if(u){const h=y(a[e-1]);t.lineTo(h,x(p)),t.closePath(),t.fill(),u=!1}}if(u){const e=y(a[a.length-1]);t.lineTo(e,x(p)),t.closePath(),t.fill()}u=!1,t.strokeStyle=X,t.lineWidth=1.5;for(let e=0;e<a.length;e++){const c=f[e];if(c>0){const h=y(a[e]),_=x(c*w);u?t.lineTo(h,_):(t.beginPath(),t.moveTo(h,_),u=!0)}else u&&(t.stroke(),u=!1)}if(u&&t.stroke(),this._hoverIndex>=0&&this._hoverIndex<a.length){const e=this._hoverIndex,c=f[e];if(c>0){const h=y(a[e]),_=x(c*w);t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(h,d),t.lineTo(h,d+g),t.stroke(),t.setLineDash([]),t.fillStyle=X,t.beginPath(),t.arc(h,_,4,0,Math.PI*2),t.fill(),t.strokeStyle="#fff",t.lineWidth=1.5,t.stroke();const Q=Math.round(c*w).toLocaleString(),V=(a[e]*R).toFixed(2),H=`${Q} ft  /  ${V} mi`;t.font="11px system-ui, sans-serif";const F=t.measureText(H).width+10,Y=20;let D=h+8;D+F>r+M&&(D=h-F-8);let S=_-24;S<d&&(S=_+8),t.fillStyle="rgba(0,0,0,0.75)",t.beginPath(),t.roundRect(D,S,F,Y,3),t.fill(),t.fillStyle="#fff",t.textAlign="left",t.textBaseline="middle",t.fillText(H,D+5,S+Y/2)}}t.restore()}_onMouseMove(s){if(!this._distances||this._distances.length<2)return;const n=this._canvas.getBoundingClientRect(),l=56,i=n.width-l-16;if(i<=0)return;const a=(s.clientX-n.left-l)/i;if(a<0||a>1){this._hoverIndex=-1,this._scheduleDraw();return}const f=a*this._distances[this._distances.length-1];let r=0,m=this._distances.length-1;for(;r<m;){const d=r+m>>1;this._distances[d]<f?r=d+1:m=d}r>0&&Math.abs(this._distances[r-1]-f)<Math.abs(this._distances[r]-f)&&r--,this._hoverIndex!==r&&(this._hoverIndex=r,this._scheduleDraw())}_onMouseLeave(){this._hoverIndex>=0&&(this._hoverIndex=-1,this._scheduleDraw())}}export{nt as ElevationProfile};
