import{vec3 as r,mat4 as p}from"https://cdn.jsdelivr.net/npm/gl-matrix@3.4.3/+esm";class P{constructor(e,t,s,i={}){this.element=e,this.mesh=t,this.controller=s,this.camera=s.camera,this.projectionView=s.projectionView,this.selectedVertexIndex=-1,this.hoverVertexIndex=-1,this.activeVertexIndex=-1,this.selectedEdgeIndex=-1,this.hoverEdgeIndex=-1,this.activeEdgeIndex=-1,this.isDragging=!1,this.dragMode=null,this.initialMousePos=[0,0],this.currentMousePos=[0,0],this.previousMousePos=[0,0],this.deadZoneRadius=5,this.exitedDeadZone=!1,this.touchStartedOnVertex=!1,this.touchVertexIndex=-1,this.backgroundClickStart=null,this.backgroundExitedDeadZone=!1,this.selectionHandledInMouseDown=!1,this.candidateEdge=null,this.dirty=!0,this.onChange=i.onChange||(()=>{}),this._onMouseDown=this._onMouseDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onMouseUp=this._onMouseUp.bind(this),this._onClick=this._onClick.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onTouchMove=this._onTouchMove.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._setup()}_setup(){const e=this.element;e.tabIndex=1,e.style.outline="none",e.addEventListener("mousedown",this._onMouseDown),e.addEventListener("mousemove",this._onMouseMove),e.addEventListener("click",this._onClick),e.addEventListener("keydown",this._onKeyDown),e.addEventListener("keyup",this._onKeyUp),e.addEventListener("touchstart",this._onTouchStart,{passive:!1}),e.addEventListener("touchmove",this._onTouchMove,{passive:!1}),e.addEventListener("touchend",this._onTouchEnd)}destroy(){const e=this.element;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mousemove",this._onMouseMove),e.removeEventListener("click",this._onClick),e.removeEventListener("keydown",this._onKeyDown),e.removeEventListener("keyup",this._onKeyUp),e.removeEventListener("touchstart",this._onTouchStart),e.removeEventListener("touchmove",this._onTouchMove),e.removeEventListener("touchend",this._onTouchEnd),window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("mouseup",this._onMouseUp)}_getMousePos(e,t=[0,0]){const s=this.element.getBoundingClientRect();return t[0]=e.clientX-s.left,t[1]=e.clientY-s.top,t}_insideDeadZone(){const e=this.currentMousePos[0]-this.initialMousePos[0],t=this.currentMousePos[1]-this.initialMousePos[1];return Math.sqrt(e*e+t*t)<this.deadZoneRadius}_getClosestVertex(e,t){const s=this.mesh;if(!s)return{index:-1,distance:1/0};const i=this.projectionView,n=this.element.offsetWidth,d=this.element.offsetHeight,o=r.create();let h=-1,a=1/0;for(let c=0;c<s.vertexCount;c++){const u=s.getPosition(c);if(r.transformMat4(o,u,i),o[2]<-1||o[2]>1)continue;const x=(.5+.5*o[0])*n,V=(.5-.5*o[1])*d,I=e-x,l=t-V,g=Math.sqrt(I*I+l*l);g<a&&(a=g,h=c)}return{index:h,distance:a}}_getClosestEdge(e,t){const s=this.mesh;if(!s)return{index:-1,distance:1/0};const i=this.projectionView,n=this.element.offsetWidth,d=this.element.offsetHeight,o=r.create(),h=r.create();let a=-1,c=1/0;for(let u=0;u<s.edgeCount;u++){const x=s.getEdge(u),V=s.getPosition(x[0]),I=s.getPosition(x[1]);if(r.transformMat4(o,V,i),r.transformMat4(h,I,i),o[2]<-1||o[2]>1||h[2]<-1||h[2]>1)continue;const l=(.5+.5*o[0])*n,g=(.5-.5*o[1])*d,M=(.5+.5*h[0])*n,m=(.5-.5*h[1])*d,f=this._pointToSegmentDistance(e,t,l,g,M,m);f<c&&(c=f,a=u)}return{index:a,distance:c}}_pointToSegmentDistance(e,t,s,i,n,d){const o=n-s,h=d-i,a=o*o+h*h;if(a<1e-4)return Math.sqrt((e-s)*(e-s)+(t-i)*(t-i));let c=((e-s)*o+(t-i)*h)/a;c=Math.max(0,Math.min(1,c));const u=s+c*o,x=i+c*h;return Math.sqrt((e-u)*(e-u)+(t-x)*(t-x))}_getSelectionTarget(e,t,s=18,i=12){const n=this._getClosestVertex(e,t),d=this._getClosestEdge(e,t),o=n.index>=0&&n.distance<s,h=d.index>=0&&d.distance<i;return n.index>=0&&n.distance<10?{type:"vertex",index:n.index,distance:n.distance}:o&&h?d.distance<=n.distance?{type:"edge",index:d.index,distance:d.distance}:{type:"vertex",index:n.index,distance:n.distance}:o?{type:"vertex",index:n.index,distance:n.distance}:h?{type:"edge",index:d.index,distance:d.distance}:{type:"none",index:-1,distance:1/0}}_onMouseDown(e){this._getMousePos(e,this.initialMousePos),this.currentMousePos[0]=this.initialMousePos[0],this.currentMousePos[1]=this.initialMousePos[1],this.previousMousePos[0]=this.initialMousePos[0],this.previousMousePos[1]=this.initialMousePos[1],this.exitedDeadZone=!1;const t=this._getSelectionTarget(this.initialMousePos[0],this.initialMousePos[1]);t.type==="vertex"?(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.element.focus(),this.selectedEdgeIndex=-1,this.selectedVertexIndex>=0&&this.selectedVertexIndex!==t.index&&(this.candidateEdge=[this.selectedVertexIndex,t.index]),this.activeVertexIndex=t.index,this.selectedVertexIndex=t.index,this.dragMode="vertex",this.element.classList.remove("cursor-pointer","cursor-grabbing"),this.element.classList.add("cursor-move"),this.selectionHandledInMouseDown=!0,this.isDragging=!0,this.dirty=!0,window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp)):t.type==="edge"?(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.element.focus(),this.selectedVertexIndex=-1,this.activeVertexIndex=-1,this.candidateEdge=null,this.selectedEdgeIndex=t.index,this.activeEdgeIndex=t.index,this.dragMode="edge",this.element.classList.remove("cursor-pointer","cursor-grabbing"),this.element.classList.add("cursor-move"),this.selectionHandledInMouseDown=!0,this.isDragging=!0,this.dirty=!0,window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp)):(this.backgroundClickStart=[this.initialMousePos[0],this.initialMousePos[1]],this.backgroundExitedDeadZone=!1,this.selectionHandledInMouseDown=!1,window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp))}_onMouseMove(e){if(this.previousMousePos[0]=this.currentMousePos[0],this.previousMousePos[1]=this.currentMousePos[1],this._getMousePos(e,this.currentMousePos),this.backgroundClickStart&&!this.backgroundExitedDeadZone){const t=this.currentMousePos[0]-this.backgroundClickStart[0],s=this.currentMousePos[1]-this.backgroundClickStart[1];Math.sqrt(t*t+s*s)>=this.deadZoneRadius&&(this.backgroundExitedDeadZone=!0,this.element.classList.remove("cursor-move","cursor-pointer"),this.element.classList.add("cursor-grabbing"))}if(!this.isDragging){if(this.backgroundClickStart)return;const t=this._getSelectionTarget(this.currentMousePos[0],this.currentMousePos[1],20,12);let s=-1,i=-1;t.type==="vertex"?s=t.index:t.type==="edge"&&(i=t.index),(s!==this.hoverVertexIndex||i!==this.hoverEdgeIndex)&&(this.hoverVertexIndex=s,this.hoverEdgeIndex=i,this.element.classList.remove("cursor-move","cursor-pointer","cursor-grabbing"),s>=0?this.element.classList.add("cursor-move"):i>=0&&this.element.classList.add("cursor-pointer"),this.dirty=!0);return}!this.exitedDeadZone&&!this._insideDeadZone()&&(this.exitedDeadZone=!0),this.dragMode==="vertex"&&this.exitedDeadZone?this._dragVertex():this.dragMode==="edge"&&this.exitedDeadZone&&this._dragEdge()}_onMouseUp(e){if(window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("mouseup",this._onMouseUp),!!this.isDragging){if(this._getMousePos(e,this.currentMousePos),!this.exitedDeadZone&&this._insideDeadZone()){const t=this._getSelectionTarget(this.currentMousePos[0],this.currentMousePos[1],20,12);if(this.dragMode==="vertex")if(t.type==="vertex")if(this.candidateEdge)if(e.shiftKey){const s=this.mesh.mergeVertices(this.candidateEdge[0],this.candidateEdge[1]);s>=0&&(this.selectedVertexIndex=s,this.selectedEdgeIndex=-1)}else this.mesh.addEdge(this.candidateEdge[0],this.candidateEdge[1]),this.selectedVertexIndex=t.index,this.selectedEdgeIndex=-1;else this.selectedVertexIndex=t.index,this.selectedEdgeIndex=-1;else this.selectedVertexIndex>=0&&this._spawnVertex()}this.isDragging=!1,this.dragMode=null,this.activeVertexIndex=-1,this.activeEdgeIndex=-1,this.candidateEdge=null,this.element.classList.remove("cursor-move","cursor-pointer","cursor-grabbing"),this.hoverVertexIndex>=0?this.element.classList.add("cursor-move"):this.hoverEdgeIndex>=0&&this.element.classList.add("cursor-pointer"),this.dirty=!0,this.onChange()}}_onClick(e){const t=this.backgroundExitedDeadZone,s=this.selectionHandledInMouseDown;if(this.backgroundClickStart=null,this.backgroundExitedDeadZone=!1,this.selectionHandledInMouseDown=!1,t||s)return;const i=this._getMousePos(e),n=this._getSelectionTarget(i[0],i[1],20,12);n.type==="vertex"?(this.selectedVertexIndex=n.index,this.selectedEdgeIndex=-1,this.element.focus(),this.dirty=!0):n.type==="edge"?(this.selectedEdgeIndex=n.index,this.selectedVertexIndex=-1,this.element.focus(),this.dirty=!0):this.selectedVertexIndex>=0?this.mesh.degree(this.selectedVertexIndex)<3?(this.currentMousePos[0]=i[0],this.currentMousePos[1]=i[1],this._spawnVertex(),this.element.focus()):(this.selectedVertexIndex=-1,this.selectedEdgeIndex=-1,this.dirty=!0):this.selectedEdgeIndex>=0&&(this.selectedEdgeIndex=-1,this.dirty=!0),this.onChange()}_getTouchPos(e,t=[0,0]){const s=this.element.getBoundingClientRect();return t[0]=e.clientX-s.left,t[1]=e.clientY-s.top,t}_onTouchStart(e){if(e.touches.length!==1){this.touchStartedOnVertex=!1,this.touchVertexIndex=-1;return}const t=this._getTouchPos(e.touches[0]),s=this._getClosestVertex(t[0],t[1]);s.index>=0&&s.distance<35?(e.stopImmediatePropagation(),e.preventDefault(),this.touchStartedOnVertex=!0,this.touchVertexIndex=s.index,this.initialMousePos[0]=t[0],this.initialMousePos[1]=t[1],this.currentMousePos[0]=t[0],this.currentMousePos[1]=t[1],this.exitedDeadZone=!1,this.selectedVertexIndex>=0&&this.selectedVertexIndex!==s.index&&(this.candidateEdge=[this.selectedVertexIndex,s.index]),this.activeVertexIndex=s.index,this.selectedVertexIndex=s.index,this.isDragging=!0,this.dragMode="vertex",this.dirty=!0):(this.touchStartedOnVertex=!1,this.touchVertexIndex=-1,this.backgroundClickStart=[t[0],t[1]],this.backgroundExitedDeadZone=!1)}_onTouchMove(e){if(e.touches.length===1&&this.backgroundClickStart&&!this.backgroundExitedDeadZone){const s=this._getTouchPos(e.touches[0]),i=s[0]-this.backgroundClickStart[0],n=s[1]-this.backgroundClickStart[1];Math.sqrt(i*i+n*n)>=this.deadZoneRadius&&(this.backgroundExitedDeadZone=!0)}if(!this.touchStartedOnVertex||e.touches.length!==1)return;e.preventDefault(),e.stopImmediatePropagation();const t=this._getTouchPos(e.touches[0]);this.previousMousePos[0]=this.currentMousePos[0],this.previousMousePos[1]=this.currentMousePos[1],this.currentMousePos[0]=t[0],this.currentMousePos[1]=t[1],!this.exitedDeadZone&&!this._insideDeadZone()&&(this.exitedDeadZone=!0),this.exitedDeadZone&&this.activeVertexIndex>=0&&this._dragVertex()}_onTouchEnd(e){if(this.touchStartedOnVertex&&e.touches.length===0){if(!this.exitedDeadZone&&this._insideDeadZone()){const t=this._getClosestVertex(this.currentMousePos[0],this.currentMousePos[1]);t.index>=0&&t.distance<35&&(this.candidateEdge&&this.mesh.addEdge(this.candidateEdge[0],this.candidateEdge[1]),this.selectedVertexIndex=t.index)}this.touchStartedOnVertex=!1,this.touchVertexIndex=-1,this.isDragging=!1,this.dragMode=null,this.activeVertexIndex=-1,this.candidateEdge=null,this.dirty=!0,this.onChange()}}_onKeyDown(e){switch(e.code){case"Space":case"Backspace":e.preventDefault(),e.stopPropagation();break}}_onKeyUp(e){switch(e.code){case"Backspace":if(this.selectedVertexIndex>=0){const t=this.mesh.deleteVertex(this.selectedVertexIndex);this.selectedVertexIndex=t,this.hoverVertexIndex=-1,this.hoverEdgeIndex=-1,this.activeVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation()}else this.selectedEdgeIndex>=0&&(this.mesh.deleteEdge(this.selectedEdgeIndex),this.selectedEdgeIndex=-1,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation());break;case"Space":this.selectedVertexIndex=-1,this.selectedEdgeIndex=-1,this.activeVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation();break;case"KeyE":if(this.selectedVertexIndex>=0){const t=this.mesh.explodeVertex(this.selectedVertexIndex);this.selectedVertexIndex=t,this.hoverVertexIndex=-1,this.activeVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation()}break;case"KeyH":if(this.selectedEdgeIndex>=0){const t=this.mesh.stoneWales(this.selectedEdgeIndex);t>=0&&(this.selectedEdgeIndex=t,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1),this.dirty=!0,e.preventDefault(),e.stopPropagation()}break;case"KeyA":if(this.selectedVertexIndex>=0){const t=this.mesh.getPosition(this.selectedVertexIndex);r.copy(this.camera.center,t)}else if(this.selectedEdgeIndex>=0){const t=this.mesh.getEdge(this.selectedEdgeIndex),s=this.mesh.getPosition(t[0]),i=this.mesh.getPosition(t[1]);this.camera.center[0]=(s[0]+i[0])/2,this.camera.center[1]=(s[1]+i[1])/2,this.camera.center[2]=(s[2]+i[2])/2}else{const t=this.mesh.computeCentroid();r.copy(this.camera.center,t)}this.dirty=!0,e.preventDefault(),e.stopPropagation();break}if(e.key==="s"){if(this.selectedVertexIndex>=0){const t=this.mesh.degree(this.selectedVertexIndex);if(t===1){const s=this.mesh.extendVertex(this.selectedVertexIndex);if(s>=0){const i=this.mesh.getEdge(s),n=this.mesh.degree(i[0])===1?i[0]:i[1];this.selectedVertexIndex=n,this.selectedEdgeIndex=-1,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1,this.dirty=!0}}else if(t===2){const s=this.mesh.splitVertex(this.selectedVertexIndex);s!==this.selectedVertexIndex&&(this.selectedVertexIndex=s,this.selectedEdgeIndex=-1,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1,this.dirty=!0)}e.preventDefault(),e.stopPropagation()}else if(this.selectedEdgeIndex>=0){const t=this.mesh.splitEdge(this.selectedEdgeIndex);t>=0&&(this.selectedEdgeIndex=t,this.selectedVertexIndex=-1,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1,this.dirty=!0),e.preventDefault(),e.stopPropagation()}}if(e.key==="v"&&this.selectedVertexIndex>=0){const t=this.mesh.extendVertex(this.selectedVertexIndex);if(t>=0){const s=this.mesh.getEdge(t),i=this.mesh.degree(s[0])===1?s[0]:s[1];this.selectedVertexIndex=i,this.selectedEdgeIndex=-1,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1,this.dirty=!0}e.preventDefault(),e.stopPropagation()}if(e.key==="c"){if(this.selectedEdgeIndex>=0){const t=this.mesh.collapseEdge(this.selectedEdgeIndex);this.selectedEdgeIndex=t,this.selectedVertexIndex=-1,this.hoverEdgeIndex=-1,this.hoverVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation()}else if(this.selectedVertexIndex>=0){const t=this.mesh.degree(this.selectedVertexIndex);if(t===1){const s=this.mesh.deleteVertex(this.selectedVertexIndex);this.selectedVertexIndex=s,this.hoverVertexIndex=-1,this.activeVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation()}else if(t===2){const s=this.mesh.collapseVertex(this.selectedVertexIndex);this.selectedVertexIndex=s,this.hoverVertexIndex=-1,this.activeVertexIndex=-1,this.dirty=!0,e.preventDefault(),e.stopPropagation()}}}if(this.selectedEdgeIndex>=0){const t=parseInt(e.key,10);t>=3&&t<=8&&(this.mesh.addFaceOnEdge(this.selectedEdgeIndex,t)&&(this.dirty=!0),e.preventDefault(),e.stopPropagation())}this.onChange()}_dragVertex(){const e=this.element.offsetWidth,t=this.element.offsetHeight,s=this.projectionView,i=this.mesh.getPosition(this.activeVertexIndex),n=r.create();r.transformMat4(n,i,s),n[0]=2*this.currentMousePos[0]/e-1,n[1]=1-2*this.currentMousePos[1]/t;const d=p.create();p.invert(d,s);const o=r.create();r.transformMat4(o,n,d),this.mesh.setPosition(this.activeVertexIndex,o[0],o[1],o[2]),this.dirty=!0}_dragEdge(){if(this.selectedEdgeIndex<0)return;const e=this.element.offsetWidth,t=this.element.offsetHeight,s=this.projectionView,i=this.mesh.getEdge(this.selectedEdgeIndex),n=this.mesh.getPosition(i[0]),d=this.mesh.getPosition(i[1]),o=r.fromValues((n[0]+d[0])/2,(n[1]+d[1])/2,(n[2]+d[2])/2),h=r.create();r.transformMat4(h,o,s);const a=2*this.previousMousePos[0]/e-1,c=1-2*this.previousMousePos[1]/t,u=2*this.currentMousePos[0]/e-1,x=1-2*this.currentMousePos[1]/t,V=u-a,I=x-c,l=p.create();p.invert(l,s);for(const g of[i[0],i[1]]){const M=this.mesh.getPosition(g),m=r.create();r.transformMat4(m,M,s),m[0]+=V,m[1]+=I;const f=r.create();r.transformMat4(f,m,l),this.mesh.setPosition(g,f[0],f[1],f[2])}this.dirty=!0}_spawnVertex(){if(this.mesh.degree(this.selectedVertexIndex)>=3)return;const e=this.element.offsetWidth,t=this.element.offsetHeight,s=this.projectionView,i=this.mesh.getPosition(this.selectedVertexIndex),n=r.create();r.transformMat4(n,i,s),n[0]=2*this.currentMousePos[0]/e-1,n[1]=1-2*this.currentMousePos[1]/t;const d=p.create();p.invert(d,s);const o=r.create();r.transformMat4(o,n,d);const h=this.mesh.addVertex(o[0],o[1],o[2]);this.mesh.addEdge(this.selectedVertexIndex,h),this.selectedVertexIndex=h,this.dirty=!0}}export{P as MeshInteractions,P as default};
