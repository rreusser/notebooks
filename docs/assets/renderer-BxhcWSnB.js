function ze(t,T,y){const O=t.createShaderModule({label:"surface-shader",code:y.surface}),J=t.createShaderModule({label:"oit-shader",code:y.oit}),K=t.createShaderModule({label:"oit-composite-shader",code:y.oitComposite}),D=t.createShaderModule({label:"peel-shader",code:y.peel}),N=t.createShaderModule({label:"peel-composite-shader",code:y.peelComposite}),C=t.createShaderModule({label:"dual-peel-shader",code:y.dualPeel}),Q=t.createBuffer({size:176,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),_=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),h=t.createBindGroup({layout:_,entries:[{binding:0,resource:{buffer:Q}}]}),B=t.createPipelineLayout({bindGroupLayouts:[_]}),fe=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}}]}),ge=t.createPipelineLayout({bindGroupLayouts:[_,fe]}),me=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),Pe=t.createPipelineLayout({bindGroupLayouts:[_,me]}),Te=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),ye=t.createPipelineLayout({bindGroupLayouts:[Te]}),he=t.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),Z=t.createPipelineLayout({bindGroupLayouts:[he]}),m=[{arrayStride:8,attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]}],xe=t.createRenderPipeline({layout:B,vertex:{module:O,entryPoint:"vs",buffers:m},fragment:{module:O,entryPoint:"fsSolid",targets:[{format:T}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"},multisample:{count:4}}),Ee=t.createRenderPipeline({layout:B,vertex:{module:O,entryPoint:"vs",buffers:m},fragment:{module:O,entryPoint:"fsWire",targets:[{format:T,blend:{color:{srcFactor:"src-alpha",dstFactor:"one",operation:"reverse-subtract"},alpha:{srcFactor:"one",dstFactor:"one",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:"always"},multisample:{count:4}}),be=t.createRenderPipeline({layout:B,vertex:{module:J,entryPoint:"vs",buffers:m},fragment:{module:J,entryPoint:"fsOIT",targets:[{format:"rgba16float",blend:{color:{srcFactor:"one",dstFactor:"one",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one",operation:"add"}}},{format:"r8unorm",blend:{color:{srcFactor:"zero",dstFactor:"one-minus-src",operation:"add"},alpha:{srcFactor:"zero",dstFactor:"one-minus-src",operation:"add"}}}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:"less"},multisample:{count:4}}),$=t.createRenderPipeline({layout:ye,vertex:{module:K,entryPoint:"vs",buffers:[]},fragment:{module:K,entryPoint:"fs",targets:[{format:T}]},primitive:{topology:"triangle-list"}}),Ge=t.createRenderPipeline({layout:B,vertex:{module:D,entryPoint:"vs",buffers:m},fragment:{module:D,entryPoint:"fsFirst",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),ee=t.createRenderPipeline({layout:ge,vertex:{module:D,entryPoint:"vs",buffers:m},fragment:{module:D,entryPoint:"fsPeel",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),te=t.createRenderPipeline({layout:Z,vertex:{module:N,entryPoint:"vs",buffers:[]},fragment:{module:N,entryPoint:"fs",targets:[{format:T,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}}),H={color:{srcFactor:"one",dstFactor:"one",operation:"max"},alpha:{srcFactor:"one",dstFactor:"one",operation:"max"}},re=[{format:"rg16float",blend:H},{format:"rgba8unorm",blend:H},{format:"rgba8unorm",blend:H}],Ae=t.createRenderPipeline({layout:B,vertex:{module:C,entryPoint:"vs",buffers:m},fragment:{module:C,entryPoint:"fsDualFirst",targets:re},primitive:{topology:"triangle-list",cullMode:"none"}}),oe=t.createRenderPipeline({layout:Pe,vertex:{module:C,entryPoint:"vs",buffers:m},fragment:{module:C,entryPoint:"fsDualPeel",targets:re},primitive:{topology:"triangle-list",cullMode:"none"}}),ae=t.createRenderPipeline({layout:Z,vertex:{module:N,entryPoint:"vs",buffers:[]},fragment:{module:N,entryPoint:"fs",targets:[{format:T,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}});let c=null,f=null,g=0,P=null,I=null,F=null,S=null,M=null,z=null,X=null,ne=null,se=0,le=0,x=[],E=[],W=[],v=[],ie=0,ue=0,b=[],G=[],A=[],Y=[],q=[],k=[],pe=0,de=0;function Be(a){const o=new Float32Array(a.positions.flat());c=t.createBuffer({size:o.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(c,0,o);const i=new Uint32Array(a.cells.flat());g=i.length,f=t.createBuffer({size:i.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(f,0,i)}function Se(a,o){P&&P.width===a&&P.height===o||(P&&P.destroy(),I&&I.destroy(),P=t.createTexture({size:[a,o],format:"depth24plus",sampleCount:4,usage:GPUTextureUsage.RENDER_ATTACHMENT}),I=t.createTexture({size:[a,o],format:T,sampleCount:4,usage:GPUTextureUsage.RENDER_ATTACHMENT}))}function Me(a,o){se===a&&le===o||(F&&F.destroy(),S&&S.destroy(),M&&M.destroy(),z&&z.destroy(),X&&X.destroy(),F=t.createTexture({size:[a,o],format:"depth24plus",sampleCount:4,usage:GPUTextureUsage.RENDER_ATTACHMENT}),S=t.createTexture({size:[a,o],format:"rgba16float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),M=t.createTexture({size:[a,o],format:"r8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),z=t.createTexture({size:[a,o],format:"rgba16float",sampleCount:4,usage:GPUTextureUsage.RENDER_ATTACHMENT}),X=t.createTexture({size:[a,o],format:"r8unorm",sampleCount:4,usage:GPUTextureUsage.RENDER_ATTACHMENT}),ne=t.createBindGroup({layout:$.getBindGroupLayout(0),entries:[{binding:0,resource:S.createView()},{binding:1,resource:M.createView()}]}),se=a,le=o)}function Re(a,o){if(ie===a&&ue===o)return;for(const e of x)e.destroy();for(const e of E)e.destroy();x=[],E=[],W=[],v=[];for(let e=0;e<2;e++)x.push(t.createTexture({size:[a,o],format:"depth32float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}));for(let e=0;e<8;e++)E.push(t.createTexture({size:[a,o],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}));const i=ee.getBindGroupLayout(1);for(let e=0;e<2;e++)W.push(t.createBindGroup({layout:i,entries:[{binding:0,resource:x[e].createView()}]}));const l=te.getBindGroupLayout(0);for(let e=0;e<8;e++)v.push(t.createBindGroup({layout:l,entries:[{binding:0,resource:E[e].createView()}]}));ie=a,ue=o}function Le(a,o){if(pe===a&&de===o)return;for(const e of b)e.destroy();for(const e of G)e.destroy();for(const e of A)e.destroy();b=[],G=[],A=[],Y=[],q=[],k=[];for(let e=0;e<2;e++)b.push(t.createTexture({size:[a,o],format:"rg16float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}));for(let e=0;e<8;e++)G.push(t.createTexture({size:[a,o],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING})),A.push(t.createTexture({size:[a,o],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}));const i=oe.getBindGroupLayout(1);for(let e=0;e<2;e++)Y.push(t.createBindGroup({layout:i,entries:[{binding:0,resource:b[e].createView()}]}));const l=ae.getBindGroupLayout(0);for(let e=0;e<8;e++)q.push(t.createBindGroup({layout:l,entries:[{binding:0,resource:G[e].createView()}]})),k.push(t.createBindGroup({layout:l,entries:[{binding:0,resource:A[e].createView()}]}));pe=a,de=o}function Ue(a){const o=Math.sqrt(10),{phi:i,theta:l,distance:e,center:s}=a.state,n=[s[0]+e*Math.cos(l)*Math.cos(i),s[1]+e*Math.sin(l),s[2]+e*Math.cos(l)*Math.sin(i)],r=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),p=((R,L,U)=>.5*(R+L+Math.sqrt((R-L)*(R-L)+U*U)))(r-o,.01,.5),d=r+o;return{eye:n,near:p,far:d}}function Ve(a,o,i,l,e,s){const n=new ArrayBuffer(176),r=new Float32Array(n),u=new Uint32Array(n);r.set(a,0),r.set(o,16),r[32]=i[0],r[33]=i[1],r[34]=i[2],r[35]=devicePixelRatio,r[36]=l.animate?(e-s)/1e3:0,r[37]=l.opacity,r[38]=l.cartoonEdgeWidth,r[39]=l.cartoonEdgeOpacity,r[40]=l.gridOpacity,r[41]=l.gridWidth,r[42]=0,u[43]=0,t.queue.writeBuffer(Q,0,n)}function we(a,o,i,l,e){Se(i,l);const s=a.beginRenderPass({colorAttachments:[{view:I.createView(),resolveTarget:o.createView(),clearValue:{r:1,g:1,b:1,a:1},loadOp:"clear",storeOp:"discard"}],depthStencilAttachment:{view:P.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"discard"}});s.setVertexBuffer(0,c),s.setIndexBuffer(f,"uint32"),s.setBindGroup(0,h),e.passes.includes("Solid surface pass")&&(s.setPipeline(xe),s.drawIndexed(g)),e.passes.includes("Fake transparency pass")&&(s.setPipeline(Ee),s.drawIndexed(g)),s.end()}function Oe(a,o,i,l){Me(i,l);const e=a.beginRenderPass({colorAttachments:[{view:z.createView(),resolveTarget:S.createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"discard"},{view:X.createView(),resolveTarget:M.createView(),clearValue:{r:1,g:0,b:0,a:0},loadOp:"clear",storeOp:"discard"}],depthStencilAttachment:{view:F.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"discard"}});e.setPipeline(be),e.setVertexBuffer(0,c),e.setIndexBuffer(f,"uint32"),e.setBindGroup(0,h),e.drawIndexed(g),e.end();const s=a.beginRenderPass({colorAttachments:[{view:o.createView(),clearValue:{r:1,g:1,b:1,a:1},loadOp:"clear",storeOp:"store"}]});s.setPipeline($),s.setBindGroup(0,ne),s.draw(3),s.end()}function De(a,o,i,l,e){Re(i,l);const s=e.peelLayers;{const n=a.beginRenderPass({colorAttachments:[{view:E[0].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:x[0].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});n.setPipeline(Ge),n.setVertexBuffer(0,c),n.setIndexBuffer(f,"uint32"),n.setBindGroup(0,h),n.drawIndexed(g),n.end()}for(let n=1;n<s;n++){const r=(n-1)%2,u=n%2,p=a.beginRenderPass({colorAttachments:[{view:E[n].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:x[u].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});p.setPipeline(ee),p.setVertexBuffer(0,c),p.setIndexBuffer(f,"uint32"),p.setBindGroup(0,h),p.setBindGroup(1,W[r]),p.drawIndexed(g),p.end()}for(let n=s-1;n>=0;n--){const r=a.beginRenderPass({colorAttachments:[{view:o.createView(),clearValue:n===s-1?{r:1,g:1,b:1,a:1}:void 0,loadOp:n===s-1?"clear":"load",storeOp:"store"}]});r.setPipeline(te),r.setBindGroup(0,v[n]),r.draw(3),r.end()}}function Ne(a,o,i,l,e){Le(i,l);const s=e.peelLayers;{const r=a.beginRenderPass({colorAttachments:[{view:b[0].createView(),clearValue:{r:-1,g:-1,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:G[0].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:A[0].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});r.setPipeline(Ae),r.setVertexBuffer(0,c),r.setIndexBuffer(f,"uint32"),r.setBindGroup(0,h),r.drawIndexed(g),r.end()}for(let r=1;r<s;r++){const u=(r-1)%2,p=r%2,d=a.beginRenderPass({colorAttachments:[{view:b[p].createView(),clearValue:{r:-1,g:-1,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:G[r].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"},{view:A[r].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}]});d.setPipeline(oe),d.setVertexBuffer(0,c),d.setIndexBuffer(f,"uint32"),d.setBindGroup(0,h),d.setBindGroup(1,Y[u]),d.drawIndexed(g),d.end()}const n=[];for(let r=0;r<s;r++)n.push(k[r]);for(let r=s-1;r>=0;r--)n.push(q[r]);for(let r=0;r<n.length;r++){const u=a.beginRenderPass({colorAttachments:[{view:o.createView(),clearValue:r===0?{r:1,g:1,b:1,a:1}:void 0,loadOp:r===0?"clear":"load",storeOp:"store"}]});u.setPipeline(ae),u.setBindGroup(0,n[r]),u.draw(3),u.end()}}function Ce(a,o,i,l,e,s,n,r){const u=l/e,{view:p,projection:d,dirty:R}=i.update(u);if(!R&&!r&&!o.animate)return!1;const{eye:L,near:U,far:j}=Ue(i),ce=1/(U-j);d[10]=j*ce,d[14]=U*j*ce,Ve(d,p,L,o,s,n);let V;try{V=a.getCurrentTexture()}catch{return!1}const w=t.createCommandEncoder();return o.method==="Fake transparency"?we(w,V,l,e,o):o.method==="Weighted blended OIT"?Oe(w,V,l,e):o.method==="Depth peeling"?De(w,V,l,e,o):o.method==="Dual depth peeling"&&Ne(w,V,l,e,o),t.queue.submit([w.finish()]),!0}return{MSAA_SAMPLES:4,MAX_PEEL_LAYERS:8,initMesh:Be,render:Ce}}export{ze as createRenderer};
