const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/pipeline-DXmWYQfp.js","assets/fft-CLtR7Cgl.js"])))=>i.map(i=>d[i]);
import{d as p,_ as oe}from"./index-ByB2dbry.js";p({root:document.getElementById("cell-2"),expanded:[],variables:[]},{id:2,body:(e,n)=>{navigator.gpu||e(n`<div style="color: red; padding: 20px; border: 1px solid red; background: #fff0f0; border-radius: 4px;">
    <strong>WebGPU is not available</strong><br>
    Please use a browser that supports WebGPU (Chrome 113+, Edge 113+, or Firefox with flags enabled).
  </div>`)},inputs:["display","html"],outputs:[],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-3"),expanded:[],variables:[]},{id:3,body:async()=>{const[{createWebGPUContext:e,isWebGPUAvailable:n},{createTuringPipelines:s},{executeFFT2D:a},{createElementStack:o},{createZoomableAxes:t},{expandable:i}]=await Promise.all([oe(()=>import("./webgpu-context-DeTOoImp.js"),[]).then(r=>{if(!("createWebGPUContext"in r))throw new SyntaxError("export 'createWebGPUContext' not found");if(!("isWebGPUAvailable"in r))throw new SyntaxError("export 'isWebGPUAvailable' not found");return r}),oe(()=>import("./pipeline-DXmWYQfp.js"),__vite__mapDeps([0,1])).then(r=>{if(!("createTuringPipelines"in r))throw new SyntaxError("export 'createTuringPipelines' not found");return r}),oe(()=>import("./fft-CLtR7Cgl.js"),[]).then(r=>{if(!("executeFFT2D"in r))throw new SyntaxError("export 'executeFFT2D' not found");return r}),oe(()=>import("./element-stack-BU40TvN2.js"),[]).then(r=>{if(!("createElementStack"in r))throw new SyntaxError("export 'createElementStack' not found");return r}),oe(()=>import("./zoomable-axes-BfGyq1bg.js"),[]).then(r=>{if(!("createZoomableAxes"in r))throw new SyntaxError("export 'createZoomableAxes' not found");return r}),oe(()=>import("./expandable-dZkDG0zz.js"),[]).then(r=>{if(!("expandable"in r))throw new SyntaxError("export 'expandable' not found");return r})]);return{createWebGPUContext:e,isWebGPUAvailable:n,createTuringPipelines:s,executeFFT2D:a,createElementStack:o,createZoomableAxes:t,expandable:i}},inputs:[],outputs:["createWebGPUContext","isWebGPUAvailable","createTuringPipelines","executeFFT2D","createElementStack","createZoomableAxes","expandable"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-4"),expanded:[],variables:[]},{id:4,body:async(e,n)=>{const s=await e(),a=s.device,o=s.precision,t=navigator.gpu.getPreferredCanvasFormat(),i=o==="f16"?2:4;return n.then(()=>a.destroy()),{context:s,device:a,precision:o,canvasFormat:t,bytesPerFloat:i}},inputs:["createWebGPUContext","invalidation"],outputs:["context","device","precision","canvasFormat","bytesPerFloat"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-5"),expanded:[],variables:[]},{id:5,body:e=>({N:parseInt(e.split("×")[0])}),inputs:["NString"],outputs:["N"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-6"),expanded:[],variables:[]},{id:6,body:()=>({gridSizeState:{N:512}}),inputs:[],outputs:["gridSizeState"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-7"),expanded:[],variables:[]},{id:7,body:()=>({expandableState:{expanded:!1}}),inputs:[],outputs:["expandableState"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-8"),expanded:[],variables:[]},{id:8,body:(e,n)=>{n.N=e},inputs:["N","gridSizeState"],outputs:[],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-9"),expanded:[],variables:[]},{id:9,body:(e,n,s,a)=>{const o=e.range([1,8],{value:4,step:1,label:"Number of scales"}),t=n(o);return s(a`<div id="turing-num-scales">${o}</div>`),{numScalesInput:o,numScalesValue:t}},inputs:["Inputs","view","display","html"],outputs:["numScalesInput","numScalesValue"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-10"),expanded:[],variables:[]},{id:10,body:e=>({numScales:Math.round(e??1)}),inputs:["numScalesValue"],outputs:["numScales"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-11"),expanded:[],variables:[]},{id:11,body:(e,n,s,a,o)=>{function t(c,b,x){const P=Math.floor(c*6),A=c*6-P,S=x*(1-b),W=x*(1-A*b),g=x*(1-(1-A)*b),G=P%6,T=[x,W,S,S,g,x][G],Q=[g,x,x,W,S,S][G],J=[S,S,g,x,x,W][G];return[T,Q,J]}function i(){return t(Math.random(),Math.random(),1)}const r=Array.from({length:10},i);function u(c,b,x=[]){const P=document.createElement("div");P.className="scale-params-container symmetry-hidden";const A=document.createElement("style");A.textContent=`
    .scale-params-container .label-full { display: inline; }
    .scale-params-container .label-short { display: none; }
    .expandable-expanded .scale-params-container .label-full { display: none; }
    .expandable-expanded .scale-params-container .label-short { display: inline; }
    .expandable-expanded .scale-params-container .input-activator { width: 40px !important; }
    .expandable-expanded .scale-params-container .input-inhibitor-ratio { width: 40px !important; }
    .expandable-expanded .scale-params-container .input-symmetry { width: 32px !important; }
    .scale-params-container.symmetry-hidden .symmetry-col { display: none; }
  `,P.appendChild(A);const S=document.createElement("table");S.style.cssText="border-collapse: collapse; width: 100%; font-size: 11px; margin: 4px 0;";const W=document.createElement("thead");W.innerHTML=`
    <tr style="text-align: left;">
      <th style="padding: 2px 4px;"><span class="label-short">A</span><span class="label-full">Activator</span></th>
      <th style="padding: 2px 4px;"><span class="label-short">I/A</span><span class="label-full">Inh/Act</span></th>
      <th style="padding: 2px 4px;"><span class="label-short">K</span><span class="label-full">Kernel</span></th>
      <th style="padding: 2px 4px;"><span class="label-short">Δ</span><span class="label-full">Amount</span></th>
      <th style="padding: 2px 4px;"><span class="label-short">W</span><span class="label-full">Weight</span></th>
      <th class="symmetry-col" style="padding: 2px 4px;"><span class="label-short">S</span><span class="label-full">Symmetry</span></th>
      <th style="padding: 2px 4px;"></th>
    </tr>
  `,S.appendChild(W);const g=document.createElement("tbody"),G=[];function T(){P.value=G.map(m=>({activatorRadius:parseFloat(m.activator.value)||2,inhibitorRatio:parseFloat(m.inhibitorRatio.value)||2,kernelType:m.kernel.value==="circular"?1:0,amount:parseFloat(m.amount.value)||.05,weight:parseFloat(m.weight.value)||1,symmetry:parseInt(m.symmetry.value)||1,color:Q(m.color.value)})),P.dispatchEvent(new CustomEvent("input"))}function Q(m){const y=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(m);return y?[parseInt(y[1],16)/255,parseInt(y[2],16)/255,parseInt(y[3],16)/255]:[.5,.5,.5]}function J(m){const y=Math.round(m[0]*255),h=Math.round(m[1]*255),Z=Math.round(m[2]*255);return"#"+[y,h,Z].map(z=>z.toString(16).padStart(2,"0")).join("")}function ie(m){const h=n.N/8,Z=c>1?m/(c-1):0,z=3*Math.pow(h/3,Z),C=.7+Math.random()*.6;return Math.round(z*C)}function ne(m){const y=[1,1,2,3,4,6,8];return{activatorRadius:ie(m),inhibitorRatio:(1.5+Math.random()*2.5).toFixed(1),kernelType:Math.random()>.5?1:0,amount:(.003+.1*Math.pow(Math.random(),2)).toFixed(3),weight:(.1+Math.random()*.9).toFixed(2),symmetry:y[Math.floor(Math.random()*y.length)],color:i()}}for(let m=0;m<c;m++){const h=x[m]||ne(m),Z=document.createElement("tr"),z=document.createElement("input");z.type="number",z.className="input-activator",z.value=h.activatorRadius,z.min=1,z.max=200,z.step=1,z.style.cssText="width: 50px; padding: 2px;",z.oninput=T;const C=document.createElement("input");C.type="number",C.className="input-inhibitor-ratio",C.value=h.inhibitorRatio,C.min=1,C.max=10,C.step=.1,C.style.cssText="width: 50px; padding: 2px;",C.oninput=T;const I=document.createElement("button");I.type="button",I.value=h.kernelType===1?"circular":"gaussian",I.style.cssText=`
      width: 24px; height: 22px; padding: 0; border: 1px solid #ccc;
      border-radius: 4px; background: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    `;const H=document.createElement("div");H.style.cssText=`
      width: 12px; height: 12px; border-radius: 50%; background: #333;
      filter: ${I.value==="gaussian"?"blur(3px)":"none"};
      transition: filter 0.15s ease;
    `,I.appendChild(H),I._dot=H,I.title=I.value==="gaussian"?"Gaussian (click for circular)":"Circular (click for gaussian)",I.onclick=()=>{I.value=I.value==="gaussian"?"circular":"gaussian",H.style.filter=I.value==="gaussian"?"blur(3px)":"none",I.title=I.value==="gaussian"?"Gaussian (click for circular)":"Circular (click for gaussian)",T()};const k=document.createElement("input");k.type="number",k.value=h.amount,k.min=.001,k.max=1,k.step=.001,k.style.cssText="width: 55px; padding: 2px;",k.oninput=T;const V=document.createElement("input");V.type="number",V.value=h.weight,V.min=0,V.max=1,V.step=.01,V.style.cssText="width: 50px; padding: 2px;",V.oninput=T;const F=document.createElement("input");F.type="number",F.className="input-symmetry",F.value=h.symmetry??1,F.min=1,F.max=8,F.step=1,F.style.cssText="width: 40px; padding: 2px;",F.oninput=T;const j=document.createElement("input");j.type="color",j.value=J(h.color),j.style.cssText="width: 36px; height: 22px; padding: 0; border: 1px solid #ccc;",j.oninput=T,[z,C,I,k,V,F,j].forEach((se,ue)=>{const ee=document.createElement("td");ee.style.padding="1px 2px",ue===5&&(ee.className="symmetry-col"),ee.appendChild(se),Z.appendChild(ee)}),g.appendChild(Z),G.push({activator:z,inhibitorRatio:C,kernel:I,amount:k,weight:V,symmetry:F,color:j})}return S.appendChild(g),P.appendChild(S),P.randomize=()=>{for(let m=0;m<G.length;m++){const y=G[m],h=ne(m);y.activator.value=h.activatorRadius,y.inhibitorRatio.value=h.inhibitorRatio,y.kernel.value=h.kernelType===1?"circular":"gaussian",y.kernel._dot.style.filter=h.kernelType===1?"none":"blur(3px)",y.amount.value=h.amount,y.weight.value=h.weight,y.symmetry.value=h.symmetry,y.color.value=J(h.color)}T()},T(),P}const l=[],d=u(e,n.N,l),E=s(d);return a(o`<div id="turing-scale-params">${d}</div>`),{hsvToRgb:t,randomColor:i,defaultColors:r,createScaleParamsInput:u,existingScaleParams:l,scaleParamsInput:d,scaleParamsValue:E}},inputs:["numScales","gridSizeState","view","display","html"],outputs:["hsvToRgb","randomColor","defaultColors","createScaleParamsInput","existingScaleParams","scaleParamsInput","scaleParamsValue"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-12"),expanded:[],variables:[]},{id:12,body:e=>({scaleParams:e??[{activatorRadius:2,inhibitorRatio:2,kernelType:0,amount:.05,weight:1,symmetry:1,color:[.33,.53,.8]}]}),inputs:["scaleParamsValue"],outputs:["scaleParams"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-13"),expanded:[],variables:[]},{id:13,body:(e,n,s,a,o)=>{const t=document.createElement("button");t.textContent="Randomize",t.style.cssText="padding: 4px 8px; cursor: pointer; font-size: 12px;",t.onclick=()=>{const u=document.querySelector("#turing-scale-params .scale-params-container");u?.randomize&&u.randomize()};const i=document.createElement("button");return i.id="turing-download-btn",i.textContent="Download PNG",i.style.cssText="padding: 4px 8px; cursor: pointer; font-size: 12px;",i.onclick=()=>{i._download&&i._download()},e.style.cssText="padding: 4px 8px; cursor: pointer; font-size: 12px;",n(s`<div id="turing-button-row" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
  ${t}
  ${e}
  ${i}
  ${a}
  ${o}
</div>`),{randomizeBtn:t,downloadBtn:i,downloadButton:i}},inputs:["restartButton","display","html","simulateInput","symmetryInput"],outputs:["randomizeBtn","downloadBtn","downloadButton"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-14"),expanded:[],variables:[]},{id:14,body:e=>{const n=document.querySelector("#turing-scale-params .scale-params-container");return n&&n.classList.toggle("symmetry-hidden",!e),{container:n}},inputs:["symmetryEnabled"],outputs:["container"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-15"),expanded:[],variables:[]},{id:15,body:(e,n,s,a,o,t,i,r,u,l)=>{const d=s`<figure style="margin: 0;">${e.element}</figure>`;return a(o(d,{width:Math.min(t,640),height:Math.min(t,640),toggleOffset:[-15,-16],controls:["#turing-num-scales","#turing-scale-params","#turing-button-row","#turing-sim-controls","#turing-display-controls"],state:i,onResize(E,c,b){e.resize(c,b),n.updateScales(r.scaleLinear().domain([0,u.N]).range([0,c]),r.scaleLinear().domain([0,u.N]).range([b,0])),l.dirty=!0}})),{figure:d}},inputs:["stack","axes","html","display","expandable","width","expandableState","d3","gridSizeState","simState"],outputs:["figure"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-16"),expanded:[],variables:[]},{id:16,body:(e,n)=>{const s=e`<div id="turing-status" style="font-family: monospace; font-size: 12px; color: #666;">Initializing...</div>`;return n(s),{statusEl:s}},inputs:["html","display"],outputs:["statusEl"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-17"),expanded:[],variables:[]},{id:17,body:(e,n,s)=>{const a=e.limits.maxComputeWorkgroupSizeX,o=[256,512,1024,2048,4096],t=o.filter(d=>{if(d<=a)return!0;const c=d/a;return Number.isInteger(c)&&(c&c-1)===0}),i=t.map(d=>`${d}×${d}`),r=512,u=n.select(i,{value:`${r}×${r}`,label:"Grid size"}),l=s(u);return{maxWorkgroupSize:a,allSizes:o,validSizes:t,gridSizeOptions:i,defaultN:r,NInput:u,NString:l}},inputs:["device","Inputs","view"],outputs:["maxWorkgroupSize","allSizes","validSizes","gridSizeOptions","defaultN","NInput","NString"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-18"),expanded:[],variables:[]},{id:18,body:e=>{const n=document.createElement("label");n.style.cssText="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;";const s=document.createElement("input");s.type="checkbox",s.checked=!0,n.appendChild(s),n.appendChild(document.createTextNode("Simulate")),n.value=!0,s.onchange=()=>{n.value=s.checked,n.dispatchEvent(new CustomEvent("input"))};const a=e(n),o=document.createElement("label");o.style.cssText="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;";const t=document.createElement("input");t.type="checkbox",t.checked=!1,o.appendChild(t),o.appendChild(document.createTextNode("Symmetry")),o.value=!1,t.onchange=()=>{o.value=t.checked,o.dispatchEvent(new CustomEvent("input"))};const i=e(o);return{simulateContainer:n,simulateCheckbox:s,simulateValue:a,symmetryContainer:o,symmetryCheckbox:t,symmetryEnabledValue:i,simulateInput:n,symmetryInput:o}},inputs:["view"],outputs:["simulateContainer","simulateCheckbox","simulateValue","symmetryContainer","symmetryCheckbox","symmetryEnabledValue","simulateInput","symmetryInput"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-19"),expanded:[],variables:[]},{id:19,body:()=>({symmetryState:{enabled:!1}}),inputs:[],outputs:["symmetryState"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-20"),expanded:[],variables:[]},{id:20,body:(e,n,s)=>{const a=e??!0,o=n??!1;return s.enabled=o,{simulate:a,symmetryEnabled:o}},inputs:["simulateValue","symmetryEnabledValue","symmetryState"],outputs:["simulate","symmetryEnabled"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-21"),expanded:[],variables:[]},{id:21,body:(e,n)=>{n.dirty=!0},inputs:["symmetryEnabled","simState"],outputs:[],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-22"),expanded:[],variables:[]},{id:22,body:(e,n,s,a,o)=>{const t=document.createElement("button");t.textContent="Restart",t.style.cssText="padding: 4px 12px; cursor: pointer; font-size: 12px;";let i=0;t.value=i,t.onclick=()=>{t.value=++i,t.dispatchEvent(new CustomEvent("input"))};const r=e(t),u=n.range([.001,1],{value:.1,step:.01,label:"Step size"}),l=e(u),d=n.range([.001,.1],{value:.01,step:.001,label:"Color rate"}),E=e(d),c=n.range([1,20],{value:5,step:1,label:"Steps per frame"}),b=e(c);return s(a`<div id="turing-sim-controls">
  <details class="sim-config-details" open>
    <summary style="cursor: pointer; font-size: 12px;">Simulation config</summary>
    <div style="padding-left: 8px;">
      <div id="turing-grid-size">${o}</div>
      ${u}
      ${d}
      ${c}
    </div>
  </details>
</div>`),{restartBtn:t,restartCount:i,restart:r,stepSizeInput:u,stepSizeValue:l,colorRateInput:d,colorRateValue:E,stepsPerFrameInput:c,stepsPerFrameValue:b,restartButton:t}},inputs:["view","Inputs","display","html","NInput"],outputs:["restartBtn","restartCount","restart","stepSizeInput","stepSizeValue","colorRateInput","colorRateValue","stepsPerFrameInput","stepsPerFrameValue","restartButton"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-23"),expanded:[],variables:[]},{id:23,body:(e,n,s)=>{const a=e??.02,o=n??.01,t=Math.round(s??5);return{stepSize:a,colorRate:o,stepsPerFrame:t}},inputs:["stepSizeValue","colorRateValue","stepsPerFrameValue"],outputs:["stepSize","colorRate","stepsPerFrame"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-24"),expanded:[],variables:[]},{id:24,body:(e,n,s,a)=>{const o=e.range([0,.99],{value:.7,step:.01,label:"Contrast"}),t=n(o),i=e.range([-2,2],{value:-1,step:.1,label:"Brightness"}),r=n(i),u=e.range([.2,3],{value:1,step:.1,label:"Gamma"}),l=n(u),d=e.range([0,1],{value:1,step:.1,label:"Color strength"}),E=n(d),c=e.toggle({label:"Invert",value:!1}),b=n(c);return s(a`<div id="turing-display-controls">
  <details class="display-config-details">
    <summary style="cursor: pointer; font-size: 12px; margin-bottom: 8px;">Display config</summary>
    <div style="padding-left: 8px;">
      ${o}
      ${i}
      ${u}
      ${d}
      ${c}
    </div>
  </details>
</div>`),{contrastInput:o,contrastValue:t,brightnessInput:i,brightnessValue:r,gammaInput:u,gammaValue:l,colorStrengthInput:d,colorStrengthValue:E,invertInput:c,invertValue:b}},inputs:["Inputs","view","display","html"],outputs:["contrastInput","contrastValue","brightnessInput","brightnessValue","gammaInput","gammaValue","colorStrengthInput","colorStrengthValue","invertInput","invertValue"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-25"),expanded:[],variables:[]},{id:25,body:(e,n,s,a,o)=>({contrast:e??.5,brightness:n??0,gamma:s??1,colorStrength:a??.5,invert:o??!1}),inputs:["contrastValue","brightnessValue","gammaValue","colorStrengthValue","invertValue"],outputs:["contrast","brightness","gamma","colorStrength","invert"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-26"),expanded:[],variables:[]},{id:26,body:(e,n,s,a,o,t,i)=>{const r=e*e*4*o,u=e*e*2*o,l=t.STORAGE|t.COPY_SRC|t.COPY_DST,d=[i.createBuffer({label:"Solution 0",size:r,usage:l}),i.createBuffer({label:"Solution 1",size:r,usage:l})],E=i.createBuffer({label:"fhat",size:u,usage:l}),c=i.createBuffer({label:"fhat_freq",size:u,usage:l}),b=[i.createBuffer({label:"FFT temp 0",size:u,usage:l}),i.createBuffer({label:"FFT temp 1",size:u,usage:l})],x=Math.ceil(n/2),P=x*e*e*4*o,A=i.createBuffer({label:"Activator/Inhibitor",size:P,usage:l}),S=i.createBuffer({label:"Init params",size:16,usage:t.UNIFORM|t.COPY_DST}),W=i.createBuffer({label:"Extract params",size:16,usage:t.UNIFORM|t.COPY_DST}),g=i.createBuffer({label:"Convolve params",size:48,usage:t.UNIFORM|t.COPY_DST}),G=i.createBuffer({label:"Pair temp 0",size:u,usage:l}),T=i.createBuffer({label:"Pair temp 1",size:u,usage:l}),Q=i.createBuffer({label:"Extract pair params",size:16,usage:t.UNIFORM|t.COPY_DST}),J=i.createBuffer({label:"Combine pair params",size:16,usage:t.UNIFORM|t.COPY_DST}),ie=i.createBuffer({label:"Update params",size:32,usage:t.UNIFORM|t.COPY_DST}),ne=i.createBuffer({label:"Scale params",size:n*32,usage:t.STORAGE|t.COPY_DST}),m=i.createBuffer({label:"Visualize params",size:40,usage:t.UNIFORM|t.COPY_DST}),y=i.createBuffer({label:"View inverse",size:64,usage:t.UNIFORM|t.COPY_DST});return{solutionSize:r,complexSize:u,bufferUsage:l,solution:d,fhat:E,fhatFreq:c,fftTemp:b,numScalePairs:x,aiSize:P,activatorInhibitor:A,initParamsBuffer:S,extractParamsBuffer:W,convolveParamsBuffer:g,pairTemp0:G,pairTemp1:T,extractPairParamsBuffer:Q,combinePairParamsBuffer:J,updateParamsBuffer:ie,scaleParamsBuffer:ne,visualizeParamsBuffer:m,viewInverseBuffer:y}},inputs:["N","numScales","restart","scaleParams","bytesPerFloat","GPUBufferUsage","device"],outputs:["solutionSize","complexSize","bufferUsage","solution","fhat","fhatFreq","fftTemp","numScalePairs","aiSize","activatorInhibitor","initParamsBuffer","extractParamsBuffer","convolveParamsBuffer","pairTemp0","pairTemp1","extractPairParamsBuffer","combinePairParamsBuffer","updateParamsBuffer","scaleParamsBuffer","visualizeParamsBuffer","viewInverseBuffer"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-27"),expanded:[],variables:[]},{id:27,body:async(e,n,s,a,o)=>({pipelines:await s(a,o,e,n)}),inputs:["N","precision","createTuringPipelines","device","canvasFormat"],outputs:["pipelines"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-28"),expanded:[],variables:[]},{id:28,body:(e,n,s,a,o,t,i)=>{const r=window.devicePixelRatio||1;function u(E,c){const b=Math.round(E*r),x=Math.round(c*r);(e.width!==b||e.height!==x)&&(e.width=b,e.height=x,n.configure({device:a,format:o,alphaMode:"opaque"})),e.style.width=`${E}px`,e.style.height=`${c}px`}const l=Math.min(t,640);u(l,l);const d=i({width:l,height:l,layers:[{id:"canvas",element:({current:E,width:c,height:b})=>(u(c,b),e)}]});return{dpr:r,resizeCanvas:u,initialSize:l,stack:d}},inputs:["canvas","ctx","N","device","canvasFormat","width","createElementStack"],outputs:["dpr","resizeCanvas","initialSize","stack"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-29"),expanded:[],variables:[]},{id:29,body:(e,n,s)=>{const a=document.createElement("canvas");a.id="turing-canvas";const o=a.getContext("webgpu");return a.width=1,a.height=1,o.configure({device:n,format:s,alphaMode:"opaque"}),{canvas:a,ctx:o}},inputs:["N","device","canvasFormat"],outputs:["canvas","ctx"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-30"),expanded:[],variables:[]},{id:30,body:(e,n,s,a,o,t)=>{const i=Math.floor(Math.random()*4294967295),r=new Uint32Array([e,e,i,0]);t.queue.writeBuffer(a,0,r);const u=t.createBindGroup({label:"Initialize bind group",layout:o.bindGroupLayouts.initialize,entries:[{binding:0,resource:{buffer:s[0]}},{binding:1,resource:{buffer:a}}]}),l=t.createCommandEncoder({label:"Initialize encoder"}),d=l.beginComputePass({label:"Initialize pass"});d.setPipeline(o.initialize),d.setBindGroup(0,u),d.dispatchWorkgroups(Math.ceil(e/16),Math.ceil(e/16),1),d.end(),t.queue.submit([l.finish()]);const E=t.createBindGroup({label:"Initialize bind group 2",layout:o.bindGroupLayouts.initialize,entries:[{binding:0,resource:{buffer:s[1]}},{binding:1,resource:{buffer:a}}]}),c=t.createCommandEncoder({label:"Initialize encoder 2"}),b=c.beginComputePass({label:"Initialize pass 2"});return b.setPipeline(o.initialize),b.setBindGroup(0,E),b.dispatchWorkgroups(Math.ceil(e/16),Math.ceil(e/16),1),b.end(),t.queue.submit([c.finish()]),{randomSeed:i,initParams:r,initBindGroup:u,initEncoder:l,initPass:d,init2BindGroup:E,init2Encoder:c,init2Pass:b}},inputs:["N","restart","solution","initParamsBuffer","pipelines","device"],outputs:["randomSeed","initParams","initBindGroup","initEncoder","initPass","init2BindGroup","init2Encoder","init2Pass"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-31"),expanded:[],variables:[]},{id:31,body:()=>({simState:{dirty:!0,solutionIndex:0,iteration:0}}),inputs:[],outputs:["simState"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-32"),expanded:[],variables:[]},{id:32,body:(e,n,s)=>{s.dirty=!0,s.solutionIndex=0,s.iteration=0},inputs:["restart","scaleParams","simState"],outputs:[],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-33"),expanded:[],variables:[]},{id:33,body:(e,n,s,a,o)=>{const t=s({d3:a,element:e.element,xScale:a.scaleLinear().domain([0,n]).range([0,e.width]),yScale:a.scaleLinear().domain([0,n]).range([e.height,0]),aspectRatio:1,onChange:()=>{o.dirty=!0}});return e.addEventListener("update",()=>{o.dirty=!0}),{axes:t}},inputs:["stack","N","createZoomableAxes","d3","simState"],outputs:["axes"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-34"),expanded:[],variables:[]},{id:34,body:(e,n,s,a,o,t,i,r,u,l,d,E,c,b,x,P,A,S,W,g,G,T,Q,J,ie,ne,m,y,h,Z,z,C,I,H,k,V,F,j,se,ue,ee,ze,Ce)=>{g.dirty=!0;const M=Math.ceil(a/16),ye=new Uint32Array([a,a,0,0]);e.queue.writeBuffer(E,0,ye);const pe=[e.createBindGroup({label:"Visualize bind group 0",layout:t.bindGroupLayouts.visualize,entries:[{binding:0,resource:{buffer:i[0]}},{binding:1,resource:{buffer:P}},{binding:2,resource:{buffer:A}}]}),e.createBindGroup({label:"Visualize bind group 1",layout:t.bindGroupLayouts.visualize,entries:[{binding:0,resource:{buffer:i[1]}},{binding:1,resource:{buffer:P}},{binding:2,resource:{buffer:A}}]})],ge=[e.createBindGroup({label:"Update bind group 0->1",layout:t.bindGroupLayouts.update,entries:[{binding:0,resource:{buffer:i[0]}},{binding:1,resource:{buffer:d}},{binding:2,resource:{buffer:i[1]}},{binding:3,resource:{buffer:b}},{binding:4,resource:{buffer:x}}]}),e.createBindGroup({label:"Update bind group 1->0",layout:t.bindGroupLayouts.update,entries:[{binding:0,resource:{buffer:i[1]}},{binding:1,resource:{buffer:d}},{binding:2,resource:{buffer:i[0]}},{binding:3,resource:{buffer:b}},{binding:4,resource:{buffer:x}}]})];function he(){const f=new Float32Array(o*8);for(let B=0;B<o;B++){const w=S[B],D=B*8;f[D+0]=w.weight,f[D+1]=w.amount,f[D+2]=T.enabled?w.symmetry:1,f[D+3]=0,f[D+4]=w.color[0],f[D+5]=w.color[1],f[D+6]=w.color[2],f[D+7]=0}e.queue.writeBuffer(x,0,f);const v=new Float32Array(8),$=new Uint32Array(v.buffer);$[0]=a,$[1]=a,$[2]=o,v[3]=Q,v[4]=J,e.queue.writeBuffer(b,0,v);const _=new Float32Array(10),q=new Uint32Array(_.buffer);q[0]=a,q[1]=a,_[2]=m,_[3]=y,_[4]=Z,_[5]=h,q[6]=z?1:0,_[8]=a,_[9]=a,e.queue.writeBuffer(P,0,_),e.queue.writeBuffer(A,0,W.viewInverse)}function xe(){const f=e.createCommandEncoder({label:`Simulation step ${g.iteration}`}),v=e.createBindGroup({layout:t.bindGroupLayouts.extract,entries:[{binding:0,resource:{buffer:i[g.solutionIndex]}},{binding:1,resource:{buffer:r}},{binding:2,resource:{buffer:E}}]}),$=f.beginComputePass({label:"Extract pass"});$.setPipeline(t.extract),$.setBindGroup(0,v),$.dispatchWorkgroups(M,M,1),$.end(),e.queue.submit([f.finish()]),C({device:e,pipelines:t.fft,input:r,output:u,temp:l,N:a,forward:!0,splitNormalization:!0});const _=Math.ceil(o/2);for(let w=0;w<_;w++){const D=w*2,re=Math.min(w*2+1,o-1),Y=S[D],O=S[re],L=new Float32Array(12),K=new Uint32Array(L.buffer);K[0]=a,K[1]=a,L[4]=Y.activatorRadius,L[5]=Y.activatorRadius*Y.inhibitorRatio,L[6]=O.activatorRadius,L[7]=O.activatorRadius*O.inhibitorRatio,K[8]=Y.kernelType,K[9]=Y.kernelType,K[10]=O.kernelType,K[11]=O.kernelType,e.queue.writeBuffer(c,0,L);const R=a*a*4*I,X=w*R,te=e.createCommandEncoder({label:`Convolve pair ${w}`}),ae=e.createBindGroup({layout:t.bindGroupLayouts.convolve,entries:[{binding:0,resource:{buffer:u}},{binding:1,resource:{buffer:d,offset:X,size:R}},{binding:2,resource:{buffer:c}}]}),N=te.beginComputePass({label:`Convolve pass ${w}`});N.setPipeline(t.convolve),N.setBindGroup(0,ae),N.dispatchWorkgroups(M,M,1),N.end(),e.queue.submit([te.finish()]);const U=new Uint32Array([a,a,0,0]);e.queue.writeBuffer(H,0,U);const Ee=e.createCommandEncoder({label:`Extract pair 0 for ${w}`}),Te=e.createBindGroup({layout:t.bindGroupLayouts.extractPair,entries:[{binding:0,resource:{buffer:d,offset:X,size:R}},{binding:1,resource:{buffer:k}},{binding:2,resource:{buffer:H}}]}),de=Ee.beginComputePass({label:"Extract pair 0"});de.setPipeline(t.extractPair),de.setBindGroup(0,Te),de.dispatchWorkgroups(M,M,1),de.end(),e.queue.submit([Ee.finish()]),C({device:e,pipelines:t.fft,input:k,output:r,temp:l,N:a,forward:!1,splitNormalization:!0});const Pe=e.createCommandEncoder({label:"Copy IFFT result 0"});Pe.copyBufferToBuffer(r,0,k,0,V),e.queue.submit([Pe.finish()]);const Fe=new Uint32Array([a,a,1,0]);e.queue.writeBuffer(H,0,Fe);const Ie=e.createCommandEncoder({label:`Extract pair 1 for ${w}`}),Re=e.createBindGroup({layout:t.bindGroupLayouts.extractPair,entries:[{binding:0,resource:{buffer:d,offset:X,size:R}},{binding:1,resource:{buffer:F}},{binding:2,resource:{buffer:H}}]}),le=Ie.beginComputePass({label:"Extract pair 1"});le.setPipeline(t.extractPair),le.setBindGroup(0,Re),le.dispatchWorkgroups(M,M,1),le.end(),e.queue.submit([Ie.finish()]),C({device:e,pipelines:t.fft,input:F,output:r,temp:l,N:a,forward:!1,splitNormalization:!0});const Be=e.createCommandEncoder({label:"Copy IFFT result 1"});Be.copyBufferToBuffer(r,0,F,0,V),e.queue.submit([Be.finish()]);const ke=new Uint32Array([a,a,0,0]);e.queue.writeBuffer(j,0,ke);const Se=e.createCommandEncoder({label:`Combine pairs for ${w}`}),_e=e.createBindGroup({layout:t.bindGroupLayouts.combinePair,entries:[{binding:0,resource:{buffer:k}},{binding:1,resource:{buffer:F}},{binding:2,resource:{buffer:d,offset:X,size:R}},{binding:3,resource:{buffer:j}}]}),ce=Se.beginComputePass({label:"Combine pairs"});ce.setPipeline(t.combinePair),ce.setBindGroup(0,_e),ce.dispatchWorkgroups(M,M,1),ce.end(),e.queue.submit([Se.finish()])}const q=e.createCommandEncoder({label:`Update ${g.iteration}`}),B=q.beginComputePass({label:"Update pass"});B.setPipeline(t.update),B.setBindGroup(0,ge[g.solutionIndex]),B.dispatchWorkgroups(M,M,1),B.end(),e.queue.submit([q.finish()]),g.solutionIndex=1-g.solutionIndex,g.iteration++}function ve(){const f=e.createCommandEncoder({label:"Render"}),v=f.beginRenderPass({colorAttachments:[{view:n.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});v.setPipeline(t.visualize),v.setBindGroup(0,pe[g.solutionIndex]),v.draw(3,1,0,0),v.end(),e.queue.submit([f.finish()])}let me;async function we(){const f=a,v=a,$=Math.ceil(f*4/256)*256,_=e.createTexture({size:[f,v],format:se,usage:ue.RENDER_ATTACHMENT|ue.COPY_SRC}),q=e.createBuffer({size:$*v,usage:ee.MAP_READ|ee.COPY_DST}),B=new Float32Array(10),w=new Uint32Array(B.buffer);w[0]=f,w[1]=v,B[2]=m,B[3]=y,B[4]=Z,B[5]=h,w[6]=z?1:0,B[8]=f,B[9]=v,e.queue.writeBuffer(P,0,B);const D=new Float32Array([f/2,0,0,0,0,v/2,0,0,0,0,1,0,f/2,v/2,0,1]);e.queue.writeBuffer(A,0,D);const re=e.createCommandEncoder({label:"Download render"}),Y=re.beginRenderPass({colorAttachments:[{view:_.createView(),loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});Y.setPipeline(t.visualize),Y.setBindGroup(0,pe[g.solutionIndex]),Y.draw(3,1,0,0),Y.end(),re.copyTextureToBuffer({texture:_},{buffer:q,bytesPerRow:$},[f,v]),e.queue.submit([re.finish()]),await q.mapAsync(ze.READ);const O=new Uint8Array(q.getMappedRange()),L=document.createElement("canvas");L.width=f,L.height=v;const K=L.getContext("2d"),R=K.createImageData(f,v);for(let te=0;te<v;te++)for(let ae=0;ae<f;ae++){const N=te*$+ae*4,U=(te*f+ae)*4;se==="bgra8unorm"?(R.data[U+0]=O[N+2],R.data[U+1]=O[N+1],R.data[U+2]=O[N+0],R.data[U+3]=255):(R.data[U+0]=O[N+0],R.data[U+1]=O[N+1],R.data[U+2]=O[N+2],R.data[U+3]=255)}K.putImageData(R,0,0),q.unmap(),q.destroy(),_.destroy(),e.queue.writeBuffer(A,0,W.viewInverse),g.dirty=!0;const X=document.createElement("a");X.download=`turing-pattern-${a}x${a}-${Date.now()}.png`,X.href=L.toDataURL("image/png"),X.click()}const fe=document.querySelector("#turing-download-btn");fe&&(fe._download=we);function be(){if(he(),ne){for(let f=0;f<ie;f++)xe();g.dirty=!0}g.dirty&&(ve(),g.dirty=!1),G.textContent=`Grid: ${a}×${a} | Scales: ${o} | Iteration: ${g.iteration}`,me=requestAnimationFrame(be)}return be(),Ce.then(()=>{cancelAnimationFrame(me)}),{workgroups:M,extractParams:ye,visualizeBindGroups:pe,updateBindGroups:ge,updateParams:he,simulationStep:xe,render:ve,animationId:me,downloadPNG:we,downloadBtnEl:fe,animate:be}},inputs:["device","ctx","canvas","N","numScales","pipelines","solution","fhat","fhatFreq","fftTemp","activatorInhibitor","extractParamsBuffer","convolveParamsBuffer","updateParamsBuffer","scaleParamsBuffer","visualizeParamsBuffer","viewInverseBuffer","scaleParams","axes","simState","statusEl","symmetryState","stepSize","colorRate","stepsPerFrame","simulate","contrast","brightness","gamma","colorStrength","invert","executeFFT2D","bytesPerFloat","extractPairParamsBuffer","pairTemp0","complexSize","pairTemp1","combinePairParamsBuffer","canvasFormat","GPUTextureUsage","GPUBufferUsage","GPUMapMode","invalidation"],outputs:["workgroups","extractParams","visualizeBindGroups","updateBindGroups","updateParams","simulationStep","render","animationId","downloadPNG","downloadBtnEl","animate"],output:void 0,assets:void 0,autodisplay:!1,autoview:void 0,automutable:void 0});p({root:document.getElementById("cell-36"),expanded:[],variables:[]},{id:36,body:(e,n)=>e`## Algorithm

Multiscale Turing patterns are a reaction-diffusion system where multiple scales of activator-inhibitor dynamics compete. At each point:

1. Convolve the field with Gaussian or circular kernels at different radii to compute activator and inhibitor values
2. Find the scale with minimum variation (smallest |activator - inhibitor|)
3. Step the field in the direction indicated by that scale (positive if activator > inhibitor)
4. Mix the color toward the dominant scale's color

### Implementation

This implementation uses several techniques to maximize throughput on the GPU:

**Packed FFTs**: We compute four real-valued FFTs in a single pass by packing data into complex pairs. The real solution field ${n`u`} is stored as a vec4 treating it as two identical complex numbers:

${n.block`(u + 0i,\; u + 0i)`}

Similarly, four convolution kernels (two activator-inhibitor pairs for scales ${n`n`} and ${n`n+1`}) are packed into two complex numbers:

${n.block`(\hat{A}_n + i\hat{I}_n,\; \hat{A}_{n+1} + i\hat{I}_{n+1})`}

where ${n`\hat{A}`} and ${n`\hat{I}`} are the frequency-domain activator and inhibitor kernels. After a single forward FFT, we multiply by two sets of frequency-domain kernels and perform one inverse FFT to recover all four convolved outputs.

**Analytical frequency-domain kernels**: Rather than storing precomputed kernel textures, we evaluate kernels analytically in the shader. The Fourier transform of a Gaussian with standard deviation ${n`\sigma`} is another Gaussian:

${n.block`\mathcal{F}\left[e^{-x^2/2\sigma^2}\right] = e^{-2\pi^2\sigma^2 f^2}`}

The Fourier transform of a circular disc of radius ${n`R`} is a Bessel function of the first kind:

${n.block`\mathcal{F}\left[\Pi(r/R)\right] = \frac{J_1(2\pi R f)}{\pi R f}`}

This eliminates kernel memory bandwidth entirely and allows arbitrary kernel parameters without regenerating textures.

**Float16 precision**: All computation uses 16-bit floating point for storage buffers, halving memory bandwidth compared to float32. The reduced precision is sufficient for the visual nature of the simulation while enabling larger grid sizes and faster execution.`,inputs:["md","tex"],outputs:[],output:void 0,assets:void 0,autodisplay:!0,autoview:!1,automutable:void 0});
