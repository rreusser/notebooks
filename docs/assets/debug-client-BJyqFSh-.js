const _="ws://localhost:9899";class h{constructor(){this.ws=null,this.sessionId=`session-${Date.now()}`,this.connected=!1,this.messageQueue=[],this.originalConsole={},this.errorObserver=null,this.sessionStartTime=Date.now(),this.sessionEnded=!1}init(){window.location.hostname!=="localhost"&&!window.location.hostname.match(/127\.0\.0\.1/)||(console.log("[DebugClient] Initializing..."),this.connect(),this.patchConsole(),this.watchForErrors(),this.watchForRuntimeErrors(),this.send({type:"session_start",sessionId:this.sessionId,timestamp:Date.now(),data:{url:window.location.href,userAgent:navigator.userAgent}}),setTimeout(()=>{this.sessionEnded||this.endSession()},5e3),window.__debugClient=this,console.log(`[DebugClient] Session started: ${this.sessionId}`))}connect(){try{this.ws=new WebSocket(_),this.ws.onopen=()=>{for(this.connected=!0,console.log("[DebugClient] Connected to debug server");this.messageQueue.length>0;){const e=this.messageQueue.shift();this.ws.send(e)}},this.ws.onclose=()=>{this.connected=!1,console.log("[DebugClient] Disconnected from debug server"),setTimeout(()=>this.connect(),2e3)},this.ws.onerror=e=>{console.error("[DebugClient] WebSocket error:",e)},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleServerMessage(t)}catch(t){console.error("[DebugClient] Failed to parse server message:",t)}}}catch(e){console.error("[DebugClient] Failed to connect:",e),setTimeout(()=>this.connect(),2e3)}}handleServerMessage(e){if(e.type==="refresh"){console.log("[DebugClient] Received refresh command"),this.sessionId=e.sessionId,window.location.reload();return}if(e.type==="get_cell_value"){this.handleCellValueRequest(e);return}if(e.type==="list_cells"){this.handleListCellsRequest(e);return}}getRuntimeModule(){if(window.__observableRuntime)return window.__observableRuntime;if(window.main)return window.main;for(const e of Object.keys(window)){const t=window[e];if(t&&typeof t.value=="function"&&t._scope)return t}return null}async handleCellValueRequest(e){const t=this.getRuntimeModule();if(!t){this.send({type:"cell_value_response",requestId:e.requestId,cellName:e.cellName,success:!1,error:"Observable runtime not found"});return}try{const s=await t.value(e.cellName);this.send({type:"cell_value_response",requestId:e.requestId,cellName:e.cellName,success:!0,value:this.serializeValue(s)})}catch(s){this.send({type:"cell_value_response",requestId:e.requestId,cellName:e.cellName,success:!1,error:s.message})}}handleListCellsRequest(e){const t=this.getRuntimeModule();if(!t||!t._scope){this.send({type:"cells_list_response",requestId:e.requestId,success:!1,error:"Observable runtime not found"});return}const s=Array.from(t._scope.keys()).filter(r=>!r.startsWith("_")).sort();this.send({type:"cells_list_response",requestId:e.requestId,success:!0,cells:s})}send(e){const t=JSON.stringify({...e,sessionId:this.sessionId,timestamp:e.timestamp||Date.now()});this.connected&&this.ws.readyState===WebSocket.OPEN?this.ws.send(t):this.messageQueue.push(t)}patchConsole(){["log","info","warn","error","debug"].forEach(t=>{this.originalConsole[t]=console[t],console[t]=(...s)=>{this.originalConsole[t](...s),this.send({type:"log",data:{level:t,args:s.map(r=>this.serializeArg(r))}})}})}serializeArg(e){if(e===null)return"null";if(e===void 0)return"undefined";const t=typeof e;if(t==="string"||t==="number"||t==="boolean")return e;if(t==="function")return`[Function: ${e.name||"anonymous"}]`;if(e instanceof Error)return{__type:"Error",message:e.message,stack:e.stack};if(e instanceof Element)return`[Element: ${e.tagName.toLowerCase()}]`;if(ArrayBuffer.isView(e))return`[TypedArray: ${e.constructor.name} length=${e.length}]`;try{const s=new WeakSet;return JSON.parse(JSON.stringify(e,(r,o)=>{if(typeof o=="object"&&o!==null){if(s.has(o))return"[Circular]";s.add(o)}return o}))}catch{return`[Object: ${Object.prototype.toString.call(e)}]`}}serializeValue(e,t=10,s=0,r=new WeakMap){if(e===null)return null;if(e===void 0)return{__type:"undefined"};const c=typeof e;if(c==="string")return e.length>1e4?{__type:"string",value:e.slice(0,1e4)+"...",truncated:!0,length:e.length}:e;if(c==="number"||c==="boolean")return e;if(c==="function"){const n=e.toString();return{__type:"Function",name:e.name||"anonymous",source:n.length>200?n.slice(0,200)+"...":n}}if(c==="object"){if(r.has(e))return{__type:"Circular",ref:r.get(e)};if(s>=t)return{__type:"MaxDepthExceeded"};r.set(e,`ref-${r.size}`)}if(e instanceof Error)return{__type:"Error",name:e.name,message:e.message,stack:e.stack};if(e instanceof HTMLCanvasElement)try{const i=e.toDataURL("image/png").split(",")[1];return{__type:"Canvas",width:e.width,height:e.height,data:i}}catch(n){return{__type:"Canvas",width:e.width,height:e.height,error:"Failed to capture: "+n.message}}if(e instanceof Element)return{__type:"Element",tagName:e.tagName.toLowerCase(),id:e.id,className:e.className,innerHTML:e.innerHTML.slice(0,500)};if(ArrayBuffer.isView(e)&&!(e instanceof DataView)){const n=Array.from(e),i=n.length>10?n.slice(0,10):n;return{__type:"TypedArray",arrayType:e.constructor.name,length:e.length,sample:i,truncated:n.length>10}}if(Array.isArray(e))return e.length>100?{__type:"Array",length:e.length,sample:e.slice(0,20).map(n=>this.serializeValue(n,t,s+1,r)),truncated:!0}:e.map(n=>this.serializeValue(n,t,s+1,r));if(e instanceof Date)return{__type:"Date",value:e.toISOString()};if(e instanceof RegExp)return{__type:"RegExp",source:e.source,flags:e.flags};if(e instanceof Map){const n=Array.from(e.entries()).slice(0,100);return{__type:"Map",size:e.size,entries:n.map(([i,a])=>[this.serializeValue(i,t,s+1,r),this.serializeValue(a,t,s+1,r)]),truncated:e.size>100}}if(e instanceof Set){const n=Array.from(e).slice(0,100);return{__type:"Set",size:e.size,values:n.map(i=>this.serializeValue(i,t,s+1,r)),truncated:e.size>100}}try{const n={},i=Object.keys(e),a=i.slice(0,100);for(const l of a)try{n[l]=this.serializeValue(e[l],t,s+1,r)}catch(f){n[l]={__type:"Error",message:"Serialization failed: "+f.message}}return i.length>a.length&&(n.__truncated=!0,n.__totalKeys=i.length),n}catch(n){return{__type:"Object",error:"Serialization failed: "+n.message,toString:Object.prototype.toString.call(e)}}}watchForErrors(){window.addEventListener("error",e=>{this.send({type:"error",data:{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,stack:e.error?.stack,source:"window.error"}})}),window.addEventListener("unhandledrejection",e=>{this.send({type:"error",data:{message:`Unhandled Promise Rejection: ${e.reason}`,stack:e.reason?.stack,source:"unhandledrejection"}})})}watchForRuntimeErrors(){const e=()=>{document.querySelectorAll(".observablehq--error").forEach(s=>{if(s.dataset.debugReported)return;s.dataset.debugReported="true";const o=s.closest(".observablehq--cell")?.id?.replace("cell-","")||"unknown",c=s.querySelector(".observablehq--inspect")?.textContent||"Unknown error";this.send({type:"runtime_error",data:{message:c,cellId:o,html:s.innerHTML.slice(0,500)}})})};this.errorCheckInterval=setInterval(e,500),this.errorObserver=new MutationObserver(t=>{for(const s of t)for(const r of s.addedNodes)if(r.nodeType===Node.ELEMENT_NODE&&(r.classList?.contains("observablehq--error")||r.querySelector?.(".observablehq--error"))){e();break}}),this.errorObserver.observe(document.body,{childList:!0,subtree:!0})}sendBinary(e,t,s){this.send({type:"binary",data:{name:e,mimeType:t,data:s}})}captureCanvas(e,t="canvas.png"){try{const r=e.toDataURL("image/png").split(",")[1];this.sendBinary(t,"image/png",r),console.log(`[DebugClient] Captured canvas: ${t}`)}catch(s){console.error("[DebugClient] Failed to capture canvas:",s)}}signalReady(){console.log("[NOTEBOOK_READY]"),this.endSession()}endSession(){this.sessionEnded||(this.sessionEnded=!0,this.send({type:"session_end",data:{duration:Date.now()-this.sessionStartTime}}),this.errorCheckInterval&&clearInterval(this.errorCheckInterval),this.errorObserver&&this.errorObserver.disconnect(),console.log("[DebugClient] Session ended"))}refresh(){window.location.reload()}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new h().init()}):new h().init();export{h as default};
