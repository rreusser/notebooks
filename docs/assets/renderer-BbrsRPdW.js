function ie(r={}){const{resolution:P=[30,30],uDomain:T=[0,1],vDomain:B=[0,1],uClosed:b=!1,vClosed:M=!1}=r,g=Array.isArray(P)?P[0]:P,p=Array.isArray(P)?P[1]:P,u=b?g:g+1,L=M?p:p+1,R=u*L,A=new Float32Array(R*2);let S=0;for(let s=0;s<u;s++){const h=T[0]+(T[1]-T[0])*s/g;for(let n=0;n<L;n++){const a=B[0]+(B[1]-B[0])*n/p;A[S++]=h,A[S++]=a}}const F=g*p*2,d=new Uint16Array(F*3);let G=0;for(let s=0;s<g;s++){let h=s+1;b&&(h=h%g);for(let n=0;n<p;n++){let a=n+1;M&&(a=a%p),d[G++]=s+u*n,d[G++]=h+u*n,d[G++]=h+u*a,d[G++]=s+u*n,d[G++]=h+u*a,d[G++]=s+u*a}}return{positions:A,cells:d,count:R}}const w=Math.PI,$=1-1e-4,v=8,k=240;function ae(r,P,T,B=150){const b=r.createShaderModule({label:"peel-shader",code:T.peel}),M=r.createShaderModule({label:"peel-composite-shader",code:T.peelComposite}),g=r.createBuffer({size:k,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),p=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),u=r.createBindGroup({layout:p,entries:[{binding:0,resource:{buffer:g}}]}),L=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}}]}),R=r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"float"}}]}),A=r.createPipelineLayout({bindGroupLayouts:[p]}),S=r.createPipelineLayout({bindGroupLayouts:[p,L]}),F=r.createPipelineLayout({bindGroupLayouts:[R]}),d=[{arrayStride:8,attributes:[{shaderLocation:0,offset:0,format:"float32x2"}]}],G=r.createRenderPipeline({layout:A,vertex:{module:b,entryPoint:"vs",buffers:d},fragment:{module:b,entryPoint:"fsFirst",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),s=r.createRenderPipeline({layout:S,vertex:{module:b,entryPoint:"vs",buffers:d},fragment:{module:b,entryPoint:"fsPeel",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list",cullMode:"none"},depthStencil:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}}),h=r.createRenderPipeline({layout:F,vertex:{module:M,entryPoint:"vs",buffers:[]},fragment:{module:M,entryPoint:"fs",targets:[{format:P,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"}});let n=null,a=null,C=0,E=[],m=[],I=[],V=[],z=0,Y=0;const O=ie({resolution:[B,B],uDomain:[-w*.5*$,w*.5*$],vDomain:[-w*(1+.05/B),w*(1+.05/B)]});n=r.createBuffer({size:O.positions.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),r.queue.writeBuffer(n,0,O.positions);const N=new Uint32Array(O.cells);C=N.length,a=r.createBuffer({size:N.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),r.queue.writeBuffer(a,0,N);function ee(l,i){if(z===l&&Y===i)return;for(const o of E)o.destroy();for(const o of m)o.destroy();E=[],m=[],I=[],V=[];for(let o=0;o<2;o++)E.push(r.createTexture({size:[l,i],format:"depth32float",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}));for(let o=0;o<v;o++)m.push(r.createTexture({size:[l,i],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}));const y=s.getBindGroupLayout(1);for(let o=0;o<2;o++)I.push(r.createBindGroup({layout:y,entries:[{binding:0,resource:E[o].createView()}]}));const t=h.getBindGroupLayout(0);for(let o=0;o<v;o++)V.push(r.createBindGroup({layout:t,entries:[{binding:0,resource:m[o].createView()}]}));z=l,Y=i}function te(l,i,y,t){const o=new ArrayBuffer(k),e=new Float32Array(o);e.set(l,0);const c=t.near,x=t.far,f=1/(c-x);e[10]=x*f,e[14]=c*x*f,e.set(i,16),e[32]=y[0],e[33]=y[1],e[34]=y[2],e[35]=t.pixelRatio,e[36]=t.t,e[37]=t.q,e[38]=t.Qinv,e[39]=t.xi,e[40]=t.eta,e[41]=t.alpha,e[42]=t.beta,e[43]=t.lambda,e[44]=t.omega,e[45]=t.n,e[46]=t.scale,e[47]=t.translation,e[48]=t.rotation,e[49]=t.stereo,e[50]=t.posClip,e[51]=t.negClip,e[52]=t.fatEdge,e[53]=t.strips,e[54]=t.shittyEversion,e[55]=t.section,e[56]=t.opacity!==void 0?t.opacity:.85,r.queue.writeBuffer(g,0,o)}function oe(l,i,y,t,o){ee(y,t),o=Math.min(o,v);{const e=l.beginRenderPass({colorAttachments:[{view:m[0].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:E[0].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});e.setPipeline(G),e.setVertexBuffer(0,n),e.setIndexBuffer(a,"uint32"),e.setBindGroup(0,u),e.drawIndexed(C),e.end()}for(let e=1;e<o;e++){const c=(e-1)%2,x=e%2,f=l.beginRenderPass({colorAttachments:[{view:m[e].createView(),clearValue:{r:0,g:0,b:0,a:0},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:E[x].createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});f.setPipeline(s),f.setVertexBuffer(0,n),f.setIndexBuffer(a,"uint32"),f.setBindGroup(0,u),f.setBindGroup(1,I[c]),f.drawIndexed(C),f.end()}for(let e=o-1;e>=0;e--){const c=l.beginRenderPass({colorAttachments:[{view:i.createView(),clearValue:e===o-1?{r:1,g:1,b:1,a:1}:void 0,loadOp:e===o-1?"clear":"load",storeOp:"store"}]});c.setPipeline(h),c.setBindGroup(0,V[e]),c.draw(3),c.end()}}function re(l,i,y,t,o){const e=t/o,{view:c,projection:x,dirty:f}=y.update(e),{phi:H,theta:_,distance:q,center:j}=y.state,U=[j[0]+q*Math.cos(_)*Math.cos(H),j[1]+q*Math.sin(_),j[2]+q*Math.cos(_)*Math.sin(H)],W=4,Q=Math.sqrt(U[0]*U[0]+U[1]*U[1]+U[2]*U[2]);i={...i,near:((D,X,K)=>.5*(D+X+Math.sqrt((D-X)*(D-X)+K*K)))(Q-W,.01,.5),far:Q+W},te(x,c,U,i);let Z;try{Z=l.getCurrentTexture()}catch{return!1}const J=r.createCommandEncoder(),ne=i.peelLayers!==void 0?i.peelLayers:4;return oe(J,Z,t,o,ne),r.queue.submit([J.finish()]),!0}return{render:re}}export{ae as createRenderer};
