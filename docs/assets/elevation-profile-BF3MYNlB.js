import{m as q,j}from"./tile-math-BziQlsn7.js";const Z=6371e3,M=3.28084,R=621371e-9;function tt(y,s,i,l){const o=Math.PI/180,n=(l-s)*o,t=(i-y)*o,a=Math.sin(n/2)**2+Math.cos(s*o)*Math.cos(l*o)*Math.sin(t/2)**2;return 2*Z*Math.asin(Math.sqrt(a))}function U(y,s){const i=y/s,l=Math.pow(10,Math.floor(Math.log10(i))),o=i/l;let n;return o<=1.5?n=1:o<=3?n=2:o<=7?n=5:n=10,n*l}class nt{constructor(){this._panel=null,this._canvas=null,this._ctx=null,this._title=null,this._resizeObserver=null,this._layerId=null,this._lineColor=null,this._distances=null,this._elevations=null,this._boundDraw=this._draw.bind(this),this._drawScheduled=!1}createDOM(){const s=document.createElement("div");s.className="elevation-profile-panel";const i=document.createElement("div");i.className="elevation-profile-header";const l=document.createElement("span");l.className="elevation-profile-title",i.appendChild(l);const o=document.createElement("button");o.className="elevation-profile-close",o.title="Close",o.innerHTML='<svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 4l8 8M12 4l-8 8"/></svg>',o.addEventListener("click",()=>this.hide()),i.appendChild(o),s.appendChild(i);const n=document.createElement("canvas");return n.className="elevation-profile-canvas",s.appendChild(n),this._panel=s,this._canvas=n,this._ctx=n.getContext("2d"),this._title=l,this._resizeObserver=new ResizeObserver(()=>this._scheduleDraw()),this._resizeObserver.observe(s),n.addEventListener("mousemove",t=>this._onMouseMove(t)),n.addEventListener("mouseleave",()=>this._onMouseLeave()),this._hoverIndex=-1,s}show(s,i,l,o){this._layerId=s,this._lineColor=o,this._title.textContent=i,this._computeDistances(l),this._panel.classList.add("visible"),this._scheduleDraw()}update(s){this._layerId&&(this._computeDistances(s),this._scheduleDraw())}hide(){this._panel.classList.remove("visible"),this._layerId=null,this._distances=null,this._elevations=null,this._hoverIndex=-1}get activeLayerId(){return this._layerId}destroy(){this._resizeObserver&&this._resizeObserver.disconnect(),this._panel&&this._panel.parentElement&&this._panel.parentElement.removeChild(this._panel)}_computeDistances(s){if(!s){this._distances=null,this._elevations=null;return}const i=[],l=[];let o=0;for(const n of s)for(let t=0;t<n.coords.length;t++){if(t>0){const a=n.coords[t-1],f=n.coords[t],r=q(a.mercatorX),v=j(a.mercatorY),d=q(f.mercatorX),L=j(f.mercatorY);o+=tt(r,v,d,L)}i.push(o),l.push(n.elevations[t])}this._distances=i,this._elevations=l}_scheduleDraw(){this._drawScheduled||(this._drawScheduled=!0,requestAnimationFrame(this._boundDraw))}_draw(){if(this._drawScheduled=!1,!this._panel.classList.contains("visible")||!this._distances)return;const s=this._canvas,i=s.getBoundingClientRect();if(i.width===0||i.height===0)return;const l=window.devicePixelRatio||1,o=Math.floor(i.width*l),n=Math.floor(i.height*l);(s.width!==o||s.height!==n)&&(s.width=o,s.height=n);const t=this._ctx;t.setTransform(l,0,0,l,0,0),t.clearRect(0,0,i.width,i.height);const a=this._distances,f=this._elevations;if(a.length<2)return;const r=56,v=16,d=10,L=24,x=i.width-r-v,m=i.height-d-L;if(x<=0||m<=0)return;let b=1/0,k=-1/0;for(const e of f)e>0&&(e<b&&(b=e),e>k&&(k=e));if(!isFinite(b))return;const O=b*M,$=k*M,B=($-O||100)*.05,g=O-B,C=$+B,z=a[a.length-1];if(z<=0)return;const T=z*R;function w(e){return r+e*R/T*x}function p(e){return d+m-(e-g)/(C-g)*m}const P=this._lineColor||[1,.53,0,1],A=Math.round(P[0]*255),W=Math.round(P[1]*255),N=Math.round(P[2]*255),X=`rgb(${A},${W},${N})`,G=`rgba(${A},${W},${N},0.3)`;t.font="10px system-ui, sans-serif",t.textBaseline="middle";const E=U(C-g,4),J=Math.ceil(g/E)*E;t.strokeStyle="rgba(0,0,0,0.08)",t.lineWidth=1,t.fillStyle="#666",t.textAlign="right";for(let e=J;e<=C;e+=E){const c=p(e);t.beginPath(),t.moveTo(r,c),t.lineTo(r+x,c),t.stroke();const h=e>=1e3?`${(e/1e3).toFixed(1)}k`:Math.round(e).toString();t.fillText(h+" ft",r-4,c)}const I=U(T,5);t.textAlign="center",t.textBaseline="top";const K=Math.ceil(0/I)*I||I;for(let e=K;e<=T;e+=I){const c=r+e/T*x;t.beginPath(),t.moveTo(c,d),t.lineTo(c,d+m),t.stroke(),t.fillStyle="#666",t.fillText(e.toFixed(1)+" mi",c,d+m+4)}t.save(),t.beginPath(),t.rect(r,d,x,m),t.clip();let u=!1;t.fillStyle=G;for(let e=0;e<a.length;e++){const c=f[e];if(c>0){const h=w(a[e]),_=p(c*M);u?t.lineTo(h,_):(t.beginPath(),t.moveTo(h,p(g)),t.lineTo(h,_),u=!0)}else if(u){const h=w(a[e-1]);t.lineTo(h,p(g)),t.closePath(),t.fill(),u=!1}}if(u){const e=w(a[a.length-1]);t.lineTo(e,p(g)),t.closePath(),t.fill()}u=!1,t.strokeStyle=X,t.lineWidth=1.5;for(let e=0;e<a.length;e++){const c=f[e];if(c>0){const h=w(a[e]),_=p(c*M);u?t.lineTo(h,_):(t.beginPath(),t.moveTo(h,_),u=!0)}else u&&(t.stroke(),u=!1)}if(u&&t.stroke(),this._hoverIndex>=0&&this._hoverIndex<a.length){const e=this._hoverIndex,c=f[e];if(c>0){const h=w(a[e]),_=p(c*M);t.strokeStyle="rgba(0,0,0,0.3)",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(h,d),t.lineTo(h,d+m),t.stroke(),t.setLineDash([]),t.fillStyle=X,t.beginPath(),t.arc(h,_,4,0,Math.PI*2),t.fill(),t.strokeStyle="#fff",t.lineWidth=1.5,t.stroke();const Q=Math.round(c*M).toLocaleString(),V=(a[e]*R).toFixed(2),H=`${Q} ft  /  ${V} mi`;t.font="11px system-ui, sans-serif";const F=t.measureText(H).width+10,Y=20;let D=h+8;D+F>r+x&&(D=h-F-8);let S=_-24;S<d&&(S=_+8),t.fillStyle="rgba(0,0,0,0.75)",t.beginPath(),t.roundRect(D,S,F,Y,3),t.fill(),t.fillStyle="#fff",t.textAlign="left",t.textBaseline="middle",t.fillText(H,D+5,S+Y/2)}}t.restore()}_onMouseMove(s){if(!this._distances||this._distances.length<2)return;const i=this._canvas.getBoundingClientRect(),l=56,n=i.width-l-16;if(n<=0)return;const a=(s.clientX-i.left-l)/n;if(a<0||a>1){this._hoverIndex=-1,this._scheduleDraw();return}const f=a*this._distances[this._distances.length-1];let r=0,v=this._distances.length-1;for(;r<v;){const d=r+v>>1;this._distances[d]<f?r=d+1:v=d}r>0&&Math.abs(this._distances[r-1]-f)<Math.abs(this._distances[r]-f)&&r--,this._hoverIndex!==r&&(this._hoverIndex=r,this._scheduleDraw())}_onMouseLeave(){this._hoverIndex>=0&&(this._hoverIndex=-1,this._scheduleDraw())}}export{nt as ElevationProfile};
