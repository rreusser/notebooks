import{executeFFT2D as pe,executeVec4FFT2D as me}from"./fft-Chkx7JT6.js";function be(y,e,J=[]){const G=document.createElement("div");G.className="scale-params-container symmetry-hidden";const Q=document.createElement("style");Q.textContent=`
    .scale-params-container .label-full { display: inline; }
    .scale-params-container .label-short { display: none; }
    .expandable-expanded .scale-params-container .label-full { display: none; }
    .expandable-expanded .scale-params-container .label-short { display: inline; }
    .expandable-expanded .scale-params-container .input-activator { width: 40px !important; }
    .expandable-expanded .scale-params-container .input-inhibitor-ratio { width: 40px !important; }
    .expandable-expanded .scale-params-container .input-symmetry { width: 32px !important; }
    .scale-params-container.symmetry-hidden .symmetry-col { display: none; }
  `,G.appendChild(Q);const p=document.createElement("table");p.style.cssText="border-collapse: collapse; width: 100%; font-size: 11px; margin: 4px 0;";const o=document.createElement("thead");o.innerHTML=`
    <tr style="text-align: left;">
      <th style="padding: 2px 4px;"><span class="label-full">Activator (A)</span><span class="label-short">A</span></th>
      <th style="padding: 2px 4px;"><span class="label-full">Inh/Act (I/A)</span><span class="label-short">I/A</span></th>
      <th style="padding: 2px 4px;"><span class="label-full">Kernel (K)</span><span class="label-short">K</span></th>
      <th style="padding: 2px 4px;"><span class="label-full">Amount (Δ)</span><span class="label-short">Δ</span></th>
      <th style="padding: 2px 4px;"><span class="label-full">Weight (W)</span><span class="label-short">W</span></th>
      <th class="symmetry-col" style="padding: 2px 4px;"><span class="label-full">Symmetry (S)</span><span class="label-short">S</span></th>
      <th style="padding: 2px 4px;"></th>
    </tr>
  `,p.appendChild(o);const I=document.createElement("tbody"),$=[];function j(a,n,t){const B=Math.floor(a*6),c=a*6-B,i=t*(1-n),s=t*(1-c*n),w=t*(1-(1-c)*n),r=B%6,T=[t,s,i,i,w,t][r],P=[w,t,t,s,i,i][r],F=[i,i,w,t,t,s][r];return[T,P,F]}function M(){return j(Math.random(),Math.random(),1)}function X(a){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return n?[parseInt(n[1],16)/255,parseInt(n[2],16)/255,parseInt(n[3],16)/255]:[.5,.5,.5]}function H(a){const n=Math.round(a[0]*255),t=Math.round(a[1]*255),B=Math.round(a[2]*255);return"#"+[n,t,B].map(c=>c.toString(16).padStart(2,"0")).join("")}function k(){G.value=$.map(a=>({activatorRadius:parseFloat(a.activator.value)||2,inhibitorRatio:parseFloat(a.inhibitorRatio.value)||2,kernelType:a.kernel.value==="circular"?1:0,amount:parseFloat(a.amount.value)||.05,weight:parseFloat(a.weight.value)||1,symmetry:parseInt(a.symmetry.value)||1,color:X(a.color.value)})),G.dispatchEvent(new CustomEvent("input"))}function N(a){const t=e.N/8,B=y>1?a/(y-1):0,c=3*Math.pow(t/3,B),i=.7+Math.random()*.6;return Math.round(c*i)}function Z(a){const n=[1,1,2,3,4,6,8];return{activatorRadius:N(a),inhibitorRatio:(1.5+Math.random()*2.5).toFixed(1),kernelType:Math.random()>.5?1:0,amount:(.1+.9*Math.random()).toFixed(2),weight:(.1+Math.random()*.9).toFixed(2),symmetry:n[Math.floor(Math.random()*n.length)],color:M()}}for(let a=0;a<y;a++){const t=J[a]||Z(a),B=document.createElement("tr"),c=document.createElement("input");c.type="number",c.className="input-activator",c.value=t.activatorRadius,c.min=1,c.max=200,c.step=1,c.style.cssText="width: 50px; padding: 2px;",c.oninput=k;const i=document.createElement("input");i.type="number",i.className="input-inhibitor-ratio",i.value=t.inhibitorRatio,i.min=1,i.max=10,i.step=.1,i.style.cssText="width: 50px; padding: 2px;",i.oninput=k;const s=document.createElement("button");s.type="button",s.value=t.kernelType===1?"circular":"gaussian",s.style.cssText=`
      width: 24px; height: 22px; padding: 0; border: 1px solid #ccc;
      border-radius: 4px; background: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    `;const w=document.createElement("div");w.style.cssText=`
      width: 12px; height: 12px; border-radius: 50%; background: #333;
      filter: ${s.value==="gaussian"?"blur(3px)":"none"};
      transition: filter 0.15s ease;
    `,s.appendChild(w),s._dot=w,s.title=s.value==="gaussian"?"Gaussian (click for circular)":"Circular (click for gaussian)",s.onclick=()=>{s.value=s.value==="gaussian"?"circular":"gaussian",w.style.filter=s.value==="gaussian"?"blur(3px)":"none",s.title=s.value==="gaussian"?"Gaussian (click for circular)":"Circular (click for gaussian)",k()};const r=document.createElement("input");r.type="number",r.value=t.amount,r.min=.001,r.max=1,r.step=.001,r.style.cssText="width: 55px; padding: 2px;",r.oninput=k;const T=document.createElement("input");T.type="number",T.value=t.weight,T.min=0,T.max=1,T.step=.01,T.style.cssText="width: 50px; padding: 2px;",T.oninput=k;const P=document.createElement("input");P.type="number",P.className="input-symmetry",P.value=t.symmetry??1,P.min=1,P.max=8,P.step=1,P.style.cssText="width: 40px; padding: 2px;",P.oninput=k;const F=document.createElement("input");F.type="color",F.value=H(t.color),F.style.cssText="width: 36px; height: 22px; padding: 0; border: 1px solid #ccc;",F.oninput=k,[c,i,s,r,T,P,F].forEach((ee,U)=>{const O=document.createElement("td");O.style.padding="1px 2px",U===5&&(O.className="symmetry-col"),O.appendChild(ee),B.appendChild(O)}),I.appendChild(B),$.push({activator:c,inhibitorRatio:i,kernel:s,amount:r,weight:T,symmetry:P,color:F})}return p.appendChild(I),G.appendChild(p),G.randomize=()=>{for(let a=0;a<$.length;a++){const n=$[a],t=Z(a);n.activator.value=t.activatorRadius,n.inhibitorRatio.value=t.inhibitorRatio,n.kernel.value=t.kernelType===1?"circular":"gaussian",n.kernel._dot.style.filter=t.kernelType===1?"none":"blur(3px)",n.amount.value=t.amount,n.weight.value=t.weight,n.symmetry.value=t.symmetry,n.color.value=H(t.color)}k()},k(),G}function he(y){const{device:e,canvasFormat:J,ctx:G,canvas:Q,pipelines:p,N:o,numScales:I,bytesPerFloat:$,referenceN:j,solution:M,fhat:X,fhatFreq:H,fftTemp:k,vec4FftWork:N,vec4FftTemp:Z,vec4FftPipelines:a,activatorInhibitor:n,extractParamsBuffer:t,convolveParamsBuffer:B,updateParamsBuffer:c,scaleParamsBuffer:i,visualizeParamsBuffer:s,viewInverseBuffer:w,simState:r,symmetryState:T,statusEl:P,memoryInfo:F,axes:ee}=y,U=Math.ceil(o/16),O=new Uint32Array([o,o,0,0]);e.queue.writeBuffer(t,0,O);const se=[e.createBindGroup({label:"Visualize bind group 0",layout:p.bindGroupLayouts.visualize,entries:[{binding:0,resource:{buffer:M[0]}},{binding:1,resource:{buffer:s}},{binding:2,resource:{buffer:w}}]}),e.createBindGroup({label:"Visualize bind group 1",layout:p.bindGroupLayouts.visualize,entries:[{binding:0,resource:{buffer:M[1]}},{binding:1,resource:{buffer:s}},{binding:2,resource:{buffer:w}}]})],ie=[e.createBindGroup({label:"Update bind group 0->1",layout:p.bindGroupLayouts.update,entries:[{binding:0,resource:{buffer:M[0]}},{binding:1,resource:{buffer:n}},{binding:2,resource:{buffer:M[1]}},{binding:3,resource:{buffer:c}},{binding:4,resource:{buffer:i}}]}),e.createBindGroup({label:"Update bind group 1->0",layout:p.bindGroupLayouts.update,entries:[{binding:0,resource:{buffer:M[1]}},{binding:1,resource:{buffer:n}},{binding:2,resource:{buffer:M[0]}},{binding:3,resource:{buffer:c}},{binding:4,resource:{buffer:i}}]})];let V={scaleParams:y.scaleParams||[],stepSize:y.stepSize??.2,colorRate:y.colorRate??.02,stepsPerFrame:y.stepsPerFrame??1,simulate:y.simulate??!0,contrast:y.contrast??.4,brightness:y.brightness??-1,gamma:y.gamma??1,colorStrength:y.colorStrength??1,invert:y.invert??!1};function ce(){const{scaleParams:f,stepSize:A,colorRate:K,contrast:S,brightness:Y,gamma:b,colorStrength:m,invert:x}=V,g=new Float32Array(I*8);for(let v=0;v<I;v++){const h=f[v],d=v*8;g[d+0]=h.weight,g[d+1]=h.amount,g[d+2]=T.enabled?h.symmetry:1,g[d+3]=0,g[d+4]=h.color[0],g[d+5]=h.color[1],g[d+6]=h.color[2],g[d+7]=0}e.queue.writeBuffer(i,0,g);const R=new Float32Array(8),u=new Uint32Array(R.buffer);u[0]=o,u[1]=o,u[2]=I,R[3]=A,R[4]=K,e.queue.writeBuffer(c,0,R);const l=new Float32Array(10),C=new Uint32Array(l.buffer);C[0]=o,C[1]=o,l[2]=S,l[3]=Y,l[4]=m,l[5]=b,C[6]=x?1:0,l[7]=o/j,l[8]=j,l[9]=j,e.queue.writeBuffer(s,0,l),e.queue.writeBuffer(w,0,ee.viewInverse)}function ue(){const{scaleParams:f}=V,A=e.createCommandEncoder({label:`Simulation step ${r.iteration}`}),K=e.createBindGroup({layout:p.bindGroupLayouts.extract,entries:[{binding:0,resource:{buffer:M[r.solutionIndex]}},{binding:1,resource:{buffer:X}},{binding:2,resource:{buffer:t}}]}),S=A.beginComputePass({label:"Extract pass"});S.setPipeline(p.extract),S.setBindGroup(0,K),S.dispatchWorkgroups(U,U,1),S.end(),e.queue.submit([A.finish()]),pe({device:e,pipelines:p.fft,input:X,output:H,temp:k,N:o,forward:!0,splitNormalization:!0});const Y=Math.ceil(I/2);for(let x=0;x<Y;x++){const g=x*2,R=Math.min(x*2+1,I-1),u=f[g],l=f[R],C=new Float32Array(12),v=new Uint32Array(C.buffer);v[0]=o,v[1]=o,C[4]=u.activatorRadius,C[5]=u.activatorRadius*u.inhibitorRatio,C[6]=l.activatorRadius,C[7]=l.activatorRadius*l.inhibitorRatio,v[8]=u.kernelType,v[9]=u.kernelType,v[10]=l.kernelType,v[11]=l.kernelType,e.queue.writeBuffer(B,0,C);const h=o*o*4*$,d=x*h,D=e.createCommandEncoder({label:`Convolve pair ${x}`}),te=e.createBindGroup({layout:p.bindGroupLayouts.convolve,entries:[{binding:0,resource:{buffer:H}},{binding:1,resource:{buffer:n,offset:d,size:h}},{binding:2,resource:{buffer:B}}]}),E=D.beginComputePass({label:`Convolve pass ${x}`});E.setPipeline(p.convolve),E.setBindGroup(0,te),E.dispatchWorkgroups(U,U,1),E.end(),e.queue.submit([D.finish()]);const L=e.createCommandEncoder({label:`Copy to vec4 work ${x}`});L.copyBufferToBuffer(n,d,N,0,h),e.queue.submit([L.finish()]),me({device:e,pipelines:a,input:N,output:N,temp:Z,N:o,forward:!1,splitNormalization:!0});const z=e.createCommandEncoder({label:`Copy from vec4 work ${x}`});z.copyBufferToBuffer(N,0,n,d,h),e.queue.submit([z.finish()])}const b=e.createCommandEncoder({label:`Update ${r.iteration}`}),m=b.beginComputePass({label:"Update pass"});m.setPipeline(p.update),m.setBindGroup(0,ie[r.solutionIndex]),m.dispatchWorkgroups(U,U,1),m.end(),e.queue.submit([b.finish()]),r.solutionIndex=1-r.solutionIndex,r.iteration++}function le(){const f=e.createCommandEncoder({label:"Render"}),A=f.beginRenderPass({colorAttachments:[{view:G.getCurrentTexture().createView(),loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});A.setPipeline(p.visualize),A.setBindGroup(0,se[r.solutionIndex]),A.draw(3,1,0,0),A.end(),e.queue.submit([f.finish()])}async function de(){const{contrast:f,brightness:A,gamma:K,colorStrength:S,invert:Y}=V,b=o,m=o,x=Math.ceil(b*4/256)*256,g=e.createTexture({size:[b,m],format:J,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),R=e.createBuffer({size:x*m,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),u=new Float32Array(10),l=new Uint32Array(u.buffer);l[0]=b,l[1]=m,u[2]=f,u[3]=A,u[4]=S,u[5]=K,l[6]=Y?1:0,u[7]=1,u[8]=b,u[9]=m,e.queue.writeBuffer(s,0,u);const C=new Float32Array([b/2,0,0,0,0,m/2,0,0,0,0,1,0,b/2,m/2,0,1]);e.queue.writeBuffer(w,0,C);const v=e.createCommandEncoder({label:"Download render"}),h=v.beginRenderPass({colorAttachments:[{view:g.createView(),loadOp:"clear",storeOp:"store",clearValue:{r:0,g:0,b:0,a:1}}]});h.setPipeline(p.visualize),h.setBindGroup(0,se[r.solutionIndex]),h.draw(3,1,0,0),h.end(),v.copyTextureToBuffer({texture:g},{buffer:R,bytesPerRow:x},[b,m]),e.queue.submit([v.finish()]),await R.mapAsync(GPUMapMode.READ);const d=new Uint8Array(R.getMappedRange()),D=document.createElement("canvas");D.width=b,D.height=m;const te=D.getContext("2d"),E=te.createImageData(b,m);for(let z=0;z<m;z++)for(let ae=0;ae<b;ae++){const _=z*x+ae*4,q=(z*b+ae)*4;J==="bgra8unorm"?(E.data[q+0]=d[_+2],E.data[q+1]=d[_+1],E.data[q+2]=d[_+0],E.data[q+3]=255):(E.data[q+0]=d[_+0],E.data[q+1]=d[_+1],E.data[q+2]=d[_+2],E.data[q+3]=255)}te.putImageData(E,0,0),R.unmap(),R.destroy(),g.destroy(),e.queue.writeBuffer(w,0,ee.viewInverse),r.dirty=!0;const L=document.createElement("a");L.download=`turing-pattern-${o}x${o}-${Date.now()}.png`,L.href=D.toDataURL("image/png"),L.click()}let W=null,ne=!0;const oe=new IntersectionObserver(f=>{ne=f[0].isIntersecting,ne&&W===null&&(W=requestAnimationFrame(re))},{threshold:0});oe.observe(Q);function re(){if(!ne){W=null;return}if(ce(),V.simulate){for(let f=0;f<V.stepsPerFrame;f++)ue();r.dirty=!0}r.dirty&&(le(),r.dirty=!1),P.textContent=`Grid: ${o}×${o} | Scales: ${I} | ${F.precision} | Memory: ${F.formatted} | Iteration: ${r.iteration}`,W=requestAnimationFrame(re)}return re(),{setParams(f){Object.assign(V,f),r.dirty=!0},downloadPNG:de,dispose(){W!==null&&cancelAnimationFrame(W),oe.disconnect()}}}export{be as createScaleParamsInput,he as createTuringSimulation};
